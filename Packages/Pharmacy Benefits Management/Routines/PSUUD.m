PSUUD ;BHM ISC/DEB - Gather Unit Dose Statistics ;20SEP93
 ;;1.0; D&PPM ;;11 May 94
UD K PSU,PSU1,PSU2,PSU3,PSUDT
UD1 S PSUDT=$S('$D(PSUDT):PSUDT1,1:$O(^PS(57.6,PSUDT))) Q:PSUDT'>0  Q:PSUDT>PSUDT2  K PSU1,PSU2,PSU3 I '$D(^PS(57.6,PSUDT,1,0)) G UD1
UD2 S PSU1=$S('$D(PSU1):$O(^PS(57.6,PSUDT,1,0)),1:$O(^PS(57.6,PSUDT,1,PSU1))) G UD1:PSU1'>0 K PSU2 I '$D(^PS(57.6,PSUDT,1,PSU1,1)) G UD2
UD3 S PSU2=$S('$D(PSU2):$O(^PS(57.6,PSUDT,1,PSU1,1,0)),1:$O(^PS(57.6,PSUDT,1,PSU1,1,PSU2))) G UD2:PSU2'>0 K PSU3
UD4 S PSU3=$S('$D(PSU3):$O(^PS(57.6,PSUDT,1,PSU1,1,PSU2,0)),1:$O(^PS(57.6,PSUDT,1,PSU1,1,PSU2,PSU3))) G UD3:PSU3'>0 K PSU4
UD5 S PSU4=$S('$D(PSU4):$O(^PS(57.6,PSUDT,1,PSU1,1,PSU2,PSU3,0)),1:$O(^PS(57.6,PSUDT,1,PSU1,1,PSU2,PSU3,PSU4))) G UD4:PSU4'>0
 S PSU41=^PS(57.6,PSUDT,1,PSU1,1,PSU2,PSU3,PSU4,0),PSU5=$P(PSU41,U,2),PSU6=$P(PSU41,U,3)
 S PSU7=$S($P(PSU41,U,4)="":0,1:$P(PSU41,U,4)),PSU8=$S($P(PSU41,U,5)="":0,1:$P(PSU41,U,5))
 S X=PSU6 D RND S PSU6=X,X=PSU8 D RND S PSU8=X
 S PSU51=$S('$D(^PSDRUG(PSU4,0)):"Unknown",1:$E($P(^PSDRUG(PSU4,0),U,1),1,40))
 ;
 S VPN=$S('$D(^PSDRUG(PSU4,"ND")):0,1:$S($P(^PSDRUG(PSU4,"ND"),U,2)="":0,1:$P(^PSDRUG(PSU4,"ND"),U,2)))
 ;
 S VCL=$S('$D(^PSDRUG(PSU4,"ND")):0,1:$S($P(^PSDRUG(PSU4,"ND"),U,6)="":0,1:$S('$D(^PS(50.605,$P(^PSDRUG(PSU4,"ND"),U,6))):0,1:$P(^PS(50.605,$P(^PSDRUG(PSU4,"ND"),U,6),0),U,1))))
 ;
 S VPN=$S(VPN=0:" ",1:$E(VPN,1,65)),VCL=$S(VCL=0:" ",1:VCL)
 ;
 I '$D(^TMP($J,"UD",PSU51)) S ^TMP($J,"UD",PSU51,0)=PSU51_U_PSU5_U_PSU6_U_PSU7_U_PSU8_U_VPN_U_VCL G UD5
 S PSU10=^TMP($J,"UD",PSU51,0)
 S $P(^TMP($J,"UD",PSU51,0),U,2)=$P(PSU10,U,2)+PSU5,$P(^TMP($J,"UD",PSU51,0),U,3)=$P(PSU10,U,3)+PSU6,$P(^TMP($J,"UD",PSU51,0),U,4)=$P(PSU10,U,4)+PSU7,$P(^TMP($J,"UD",PSU51,0),U,5)=$P(PSU10,U,5)+PSU8 G UD5
RND Q:X'?.E1".".N  K XX,XXXX,XXX S XX=$P(X,".",2) Q:$L(XX)'>2  S XX=$E(XX,1,2),XXX=$E($P(X,".",2),3),XXXX=$S($P(X,".",1)="":"."_XX,1:$P(X,".",1)_"."_XX) I XXX>4 S X=XXXX+.01 Q
 Q
 ;
