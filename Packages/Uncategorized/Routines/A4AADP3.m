A4AADP3 ;HINES-CIOFO/JJM - PROGRAM TO AUDIT DEBTOR  7/29/99 22:00
V ;;1.0;**** CLASS III ****;;JUN 30, 1998
 ;; VARIABLE PREFIX FA REPRESENTS FILE 430 
 ;; VARIABLE PREFIX FB REPRESENTS FILE 433
START ;
 W !,?30,"AUDIT FILE 433 (A4AADP3)"
 D NOW^%DTC
 W !,"JOB STARTED: ",%
 W !,^PRCA(430,0)
BY433 ;;
 D INIT
 W "CHECKING FILE 433"
 S TN=0,DCNT=0,RCNT=0
 F I=1:1 S TN=$O(^PRCA(433,TN)) W:(I#10)=0 "." Q:'TN  D
   . S RCNT=RCNT+1,TERRCNT=ERRCNT
   . D GET433D ; Q:(FBN0P4=1)&(FBN0P10=1)
   . S BN=+$G(BN433)
   . S BILL=+$G(BN433)
   . D GET430D
   . S DEBTOR=+$G(FAN0P9)
   . D CHK433^A4AADP1
   . D C430XR
   . I ERRCNT'=TERRCNT D
       .. W !,$J(TN,6)," HAS ",$J((ERRCNT-TERRCNT),5)," ERRORS"
 W !,$J(ERRCNT,10)," ERRORS FOUND"
 W !,$J(RCNT,10)," TRANSACTIONS  CHECKED (",+$P(^PRCA(433,0),U,3),")"
 D:ERRCNT>0 ERRLIST^A4AADP2
 D EXIT
 W !,"EOJ"
 QUIT
INIT ;
 S BN=0,TN=0,RCNT=0,DCNT=0,BCNT=0,TCNT=0,TERRCNT=0,ERRCNT=0
 QUIT
EXIT ;
 K ERRCNT,OK,I,ICS,BN,TN,RCNT,DCNT,BCNT,TCNT,TERRCNT
 QUIT
CHK1 S:$G(DAT) TDT=DAT
CHK433D ;; CHECK TRANSACTION DATA
 S ERRCODE=0
 Q:('TN)
 D GET433D
 S BN=BN433
 S:'FBN0 ERRCODE=1
 QUIT
GET433D ;; GET DATA FROM FILE 433
 Q:'TN
 S FBN0=$G(^PRCA(433,TN,0))
 S FBN1=$G(^PRCA(433,TN,1))
 S FBN0P1=+$P(FBN0,U,1) ; TRANSACTION NUMBER FROM FILE 433
 S FBN0P2=+$P(FBN0,U,2) ; BILL NUMBER  FROM FILE 433
 S FBN0P4=+$P(FBN0,U,4) ; TRANSACTION STATUS  FROM FILE 433
 S FBN0P10=+$P(FBN0,U,10) ; INCOMPLETED TRANSACTION FLAG  FROM FILE 433
 S FBN1P2=+$P(FBN1,U,2) ; TRANSACTION TYPE FROM FILE 433
 S FBN1P9=+$P(FBN1,U,9) ; DATE ENTERED FROM FILE 433
 S BN433=FBN0P2
 QUIT
CHK10 ;; 
 S ERRCODE=0
 Q:'TN
 D:$G(FBN0) GET433D
 S:'FBN0P1 ERRCODE=10
 QUIT
CHK11 ;; 
 S ERRCODE=0
 Q:'TN
 D:$G(FBN0) GET433D
 S:('FBN0P2)&(FBN0P10'=1)&(FBN0P4=2) ERRCODE=11
 QUIT
CHK12 ;; 
 S ERRCODE=0
 Q:'TN
 D:$G(FBN1) GET433D
 S:('FBN1P2)&(FBN0P10'=1)&(FBN0P4=2) ERRCODE=12
 QUIT
CHK13 ;; 
 S ERRCODE=0
 Q:'TN
 D:$G(FBN1) GET433D
 S:('FBN1P9)&(FBN0P10'=1)&(FBN0P4=2) ERRCODE=13
 QUIT
CHK430D ; CHECK BILL DATA
CHK2 ;;
 S ERRCODE=0
 Q:'BN
 D GET430D ; GET FILE 430 DATA
 S:'FAN0 ERRCODE=2
 S OK=ERRCODE
 Q
CHK20 ;;
 S ERRCODE=0
 Q:'BN
 S:'FAN0P1 ERRCODE=20
 S OK=ERRCODE
 Q
CHK21 ;;
 S ERRCODE=0
 Q:'BN
 D GET430D ; GET FILE 430 DATA
 S:'FAN0P8 ERRCODE=21
 S OK=ERRCODE
 Q
CHK22 ;;
 S ERRCODE=0
 Q:'BN
 D GET430D ; GET FILE 430 DATA
 I "^15^48^49^"[("^"_FAN0P8_"^") QUIT
 Q:((FAN0P8=26)!(FAN0P8=27)!(FAN0P8=39)!(FAN0P8=40))&('FAN0P9)
 S:'FAN0P9 ERRCODE=22
 S OK=ERRCODE
 S:DEBTOR'=FAN0P9 ERRCODE=1002
 S OK=ERRCODE
 Q
CHK23 ;;
 S ERRCODE=0
 Q:'BN
 D GET430D ; GET FILE 430 DATA
 I "^15^17^48^49^"[("^"_FAN0P8_"^") QUIT
 Q:((FAN0P8=26)!(FAN0P8=27)!(FAN0P8=39)!(FAN0P8=40))&('FAN6P21)
 S:'FAN6P21 ERRCODE=23
 S OK=ERRCODE
 Q
CHK32 ;;
 S ERRCODE=0
 Q:'BN
 D GET430D ; GET FILE 430 DATA
 Q:'FAN0P9
 S:'$G(^RCD(340,+FAN0P9,0)) ERRCODE=32
 S OK=ERRCODE
 Q
GET430D ;; GET DATA FROM FILE 430
 S:'$G(BN) BN=$G(BILL)
 S:'BN BN=FBN0P2
 Q:'BN
 S FAN0=$G(^PRCA(430,BN,0))
 S FAN6=$G(^PRCA(430,BN,6))
 S FAN0P1=$P($G(FAN0),U,1) ; BILL NO. FROM FILE 430
 S FAN0P2=$P($G(FAN0),U,2) ; BILL CATEGORY FROM FILE 430
 S FAN0P8=+$P($G(FAN0),U,8) ; CURRENT STATUS FROM FILE 430
 S FAN0P9=+$P($G(FAN0),U,9) ; DEBTOR FROM FILE 430
 S FAN6P9=+$P($G(FAN6),U,9) ; PREVIOUS BILL STATUS FROM FILE 430
 S FAN6P21=+$P($G(FAN6),U,21) ; DATE ACCOUNT ACTIVATED FROM FILE 430
 QUIT
C433XR ;; CHECK FILE 433 CROSS REFERENCES
 S (ERRCODE,NAT,NATD,NAW,NB,NC,DPT)=0
 Q:('TN)!('BN)
 D:'$G(FBN0) GET433D
 D:'$G(FAN0) GET430D,C430XR
 S:FBN1P2>0 NAT=$D(^PRCA(433,"AT",FBN1P2,$P(FBN1P9,".",1),TN))
 I 'NAT S ERRCNT=ERRCNT+1 W !,$J(ERRCNT,8),$J(DEBTOR,8),$J(BN,8),$J($G(FAN0P8),3),$J(TN,8),?40,"ERROR # ",100," ^PRCA(433,""AT"",",$P(FBN1P9,".",1),",",TN,")" S ERRCODE=0
 I $P($G(^RCD(340,+$P($G(^PRCA(430,+$P($G(^PRCA(433,TN,0)),"^",2),0)),"^",9),0)),"^")[(";DPT(") S DPT=1
 S:(FBN1P9>0)&(FAN0P9>0) NATD=$D(^PRCA(433,"ATD",FAN0P9,FBN1P9,TN))
 I ('NATD)&(DPT=1) S ERRCNT=ERRCNT+1 W !,$J(ERRCNT,8),$J(DEBTOR,8),$J(BN,8),$J($G(FAN0P8),3),$J(TN,8),?40,"ERROR # ",101," ^PRCA(433,""ATD"",",FAN0P9,",",FBN1P9,",",TN,")"  S ERRCNT=ERRCNT+1
 S ERRCODE=0
 I (DEBTOR'=FAN0P9) S ERRCNT=ERRCNT+1 W !,$J(ERRCNT,8),$J(DEBTOR,8),$J(BN,8),$J($G(FAN0P8),3),$J(TN,8),?40,"ERROR # ",1002," ^PRCA(433,""ATD"",",FAN0P9,",",FBN1P9,",",TN,")" S ERRCODE=0
 S:FBN1P2>0 NAW=$D(^PRCA(433,"AW",FBN1P2,TN))
 I ('NAW)&(+(FBN1P2)>7)&(+(FBN1P2)<12) S ERRCNT=ERRCNT+1 W !,$J(ERRCNT,8),$J(DEBTOR,8),$J(BN,8),$J($G(FAN0P8),3),$J(TN,8),?40,"ERROR # ",103," ^PRCA(433,""AW"",",FBN1P2,",",TN,")" S ERRCODE=0
 S:TN>0 NB=$D(^PRCA(433,"B",TN,TN))
 I 'NB S ERRCNT=ERRCNT+1 W !,$J(ERRCNT,8),$J(DEBTOR,8),$J(BN,8),$J($G(FAN0P8),3),$J(TN,8),?40,"ERROR # ",104," ^PRCA(433,""B"",",TN,",",TN,")" S ERRCODE=0
 S:BN>0 NC=$D(^PRCA(433,"C",BN,TN))
 I 'NC S ERRCNT=ERRCNT+1 W !,$J(ERRCNT,8),$J(DEBTOR,8),$J(BN,8),$J($G(FAN0P8),3),$J(TN,8),?40,"ERROR # ",105," ^PRCA(433,""C"",",BN,",",TN,")" S ERRCODE=0
 QUIT
C430XR ;; CHECK FILW 430 CROSS REFERENCES
 S ERRCODE=0
 Q:'$G(BN)
 D:'$G(FAN0) GET430D
 S (ERRCODE,NAC,NACTDT,NATD,NB,NC,ND)=0
 S XTN=" "
 S:$D(TN) XTN=TN
 S:FAN0P8'="" NAC=$D(^PRCA(430,"AC",FAN0P8,BN))
 I 'NAC D
   . Q:(FAN0P8=15)!(FAN0P8=18)!(FAN0P8=20)!(FAN0P8=27)!(FAN0P8=48)!(FAN0P8=49)
   . Q:((FAN0P8=26)!(FAN0P8=27))&('FAN0P9)
  . S ERRCNT=ERRCNT+1
  . W !,$J(ERRCNT,8),$J(DEBTOR,8),$J(BN,8),$J($G(FAN0P8),3),$J(XTN,8),?40,"ERROR # ",200," ^PRCA(430,""AC"",",FAN0P8,",",BN,")"
  . S ERRCODE=0
 
 S:FAN6P21'="" NACTDT=$D(^PRCA(430,"ACTDT",$P(FAN6P21,"."),BN))
 I FAN0P9,'NACTDT D
   . Q:'FAN6P21
   . I "^15^17^18^20^21^26^27^28^49^"[("^"_FAN0P8_"^")!((FAN0P8=31)&(FAN6P9'="")) QUIT
   . S ERRCNT=ERRCNT+1
   . W !,$J(ERRCNT,8),$J(DEBTOR,8),$J(BN,8),$J($G(FAN0P8),3),$J(XTN,8),?40,"ERROR # ",201," ^PRCA(430,""ACTDT"",",$P(FAN6P21,"."),",",BN,")"
   . S ERRCODE=0
 S:FAN0P9'="" NAS=$D(^PRCA(430,"AS",FAN0P9,FAN0P8,BN))
 I 'NAS D
   . Q:(FAN0P8=15)!(FAN0P8=17)!(FAN0P8=18)!(FAN0P8=20)!(FAN0P8=27)!(FAN0P8=48)!(FAN0P8=49)
   . Q:((FAN0P8=26)!(FAN0P8=27)!(FAN0P8=39)!(FAN0P8=40))&('FAN0P9)
   . S ERRCNT=ERRCNT+1
   . W !,$J(ERRCNT,8),$J(DEBTOR,8),$J(BN,8),$J($G(FAN0P8),3),$J(XTN,8),?40,"ERROR # ",202," ^PRCA(430,""AS"",",FAN0P9,",",FAN0P8,",",BN,")"
   . S ERRCODE=0
 I DEBTOR'=FAN0P9 D
   . W !,$J(ERRCNT,8),$J(DEBTOR,8),$J(BN,8),$J($G(FAN0P8),3),$J(XTN,8),?40,"ERROR # ",1002," ^PRCA(430,""AS"",",FAN0P9,",",FAN0P8,",",BN,")"
   . S ERRCNT=ERRCNT+1
   . S ERRCODE=0
 S:FAN0P1'="" NB=$D(^PRCA(430,"B",FAN0P1,BN))
 I 'NB S ERRCNT=ERRCNT+1 W !,$J(ERRCNT,8),$J(DEBTOR,8),$J(BN,8),$J($G(FAN0P8),3),$J(XTN,8),?40,"ERROR # ",204," ^PRCA(430,""B"",",FAN0P1,",",BN,")"  S ERRCODE=0
 S:FAN0P9>0 NC=$D(^PRCA(430,"C",FAN0P9,BN))
 I ('NC) D
   . Q:(FAN0P8=15)!(FAN0P8=18)!(FAN0P8=27)!(FAN0P8=48)!(FAN0P8=49)
   . Q:((FAN0P8=26)!(FAN0P8=27)!(FAN0P8=39)!(FAN0P8=40))&('FAN0P9)
   . W !,$J(ERRCNT,8),$J(DEBTOR,8),$J(BN,8),$J($G(FAN0P8),3),$J(XTN,8),?40,"ERROR # ",205," ^PRCA(430,""C"",",FAN0P9,",",BN,")"
   . S ERRCNT=ERRCNT+1
   . S ERRCODE=0
 I DEBTOR'=FAN0P9 D
   . W !,$J(ERRCNT,8),$J(DEBTOR,8),$J(BN,8),$J($G(FAN0P8),3),$J(XTN,8),?40,"ERROR # ",1002," ^PRCA(430,""C"",",FAN0P9,",",BN,")"
   . S ERRCNT=ERRCNT+1
   . S ERRCODE=0
 S:FAN0P1'="" ND=$D(^PRCA(430,"D",$P(FAN0P1,"-",2),BN))
 I 'ND S ERRCNT=ERRCNT+1 W !,$J(ERRCNT,8),$J(DEBTOR,8),$J(BN,8),$J($G(FAN0P8),3),$J(XTN,8),?40,"ERROR # ",206," ^PRCA(430,""D"",",$P(FAN0P1,"-",2),",",BN,")"  S ERRCODE=0
 S:FAN0P8'="" NATD=$D(^PRCA(430,"ATD",FAN0P9,FAN6P21,BN))
 Q:(FAN0P8=15)!(FAN0P8=18)!(FAN0P8=20)!(FAN0P8=27)!(FAN0P8=48)!(FAN0P8=49)
 S DPT=0
 I $D(^RCD(340,DEBTOR,0)),$P(^(0),"^")[";DPT(",$D(^PRCA(430,BN,6)),$P(^(6),"^",21) S DPT=1
 I ('NATD)&(DPT=1) D
   . Q:(FAN0P8=15)!(FAN0P8=18)!(FAN0P8=20)!(FAN0P8=27)!(FAN0P8=48)!(FAN0P8=49)
   . S ERRCNT=ERRCNT+1
   . W !,$J(ERRCNT,8),$J(DEBTOR,8),$J(BN,8),$J($G(FAN0P8),3),$J(XTN,8),?40,"ERROR # ",203," ^PRCA(430,""ATD"",",FAN0P9,",",FAN6P21,",",BN,")"
   . S ERRCODE=0
 I DEBTOR'=FAN0P9 D
   . W !,$J(ERRCNT,8),$J(DEBTOR,8),$J(BN,8),$J($G(FAN0P8),3),$J(XTN,8),?40,"ERROR # ",1002," ^PRCA(430,""ATD"",",FAN0P9,",",FAN6P21,",",BN,")"
   . S ERRCNT=ERRCNT+1
   . S ERRCODE=0
 QUIT
