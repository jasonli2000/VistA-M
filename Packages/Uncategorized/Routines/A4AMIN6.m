A4AMIN6 ;HINES-CIOFO/JJM - COMPUTES A4ATNA 7/27/98 13:10
V ;;1.0;**** CLASS III ****;;JUN 30, 1998
 ;; COMPUTES REPORT TOTALS
 ;;S FLAG1=1 TO LIST TRANSACTIONS
 ;; FLAG1=0 DEFAULT
 D DEBTOR^A4AARPT
 I Y=-1 D EOR6 QUIT
ASKDEV ;
 S %ZIS="QM",%ZIS("B")=""
 D ^%ZIS
 D:'POP EN1
CLOSEDV ; CLOSE DEVICE
 W:IO'=IO(0) @IOF D ^%ZISC
 D EOR6
 QUIT 
EN1 S:'$D(FLAG1) FLAG1=0
 D CRT
 D EOR6
 QUIT
CRT ; COMPUTE REPORT TOTALS
 S:'$G(DEBTOR) DEBTOR=A4ADEB
 Q:'$G(DEBTOR)
 S (A4ATL1,A4ATL2,A4ATL3,A4ATL4,A4ATL5,A4ATL6,A4ATL7,A4ATL8,A4ATL9,A4ATL10)=0
 D ^A4AMIN5
 N TRANS,BILL,DATE1,DATE2,TIME1,TIME2,RBAL,SRBAL,BS
 N LST1,LST2,LST3,LST4,LST5,LST6
 S (RBAL,NATOTAL,SRBAL)=0,BS=" "
 S (LST1,LST2,LST3,LST4,LST5,LST6)=0
 S A4ATOA=0,A4ATL6=0
 D GETDAT^A4AARPT2
 F BILL=0:0 S BILL=$O(^PRCA(430,"C",DEBTOR,BILL)) Q:'BILL  D
   . D CALCCBAL^A4AARPT
   . S BN=BILL
   . D GET430D^A4AADP3
   . S CS=$P(FAN0,U,8)
   . Q:(CS=15)!(CS=18)!(CS=27)!(CS=40)!(CS=48)!(CS=49)
   . D PRTTRAN2^A4AARPT2
   . S A4ATOA=A4ATOA+BAL
   . F TRANS=0:0 S TRANS=$O(^PRCA(433,"C",BILL,TRANS)) Q:'TRANS  D PRTTRAN3^A4AARPT2
   . S A4ATL6=A4ATL6+BAL
 D PCLDFAR^A4AMIN5
 QUIT
EOR6 ;
 K AB,BAL,BBAL,BN,CA,CC,DAT,DATE3,DEB,DEBTOR,END,EP,F433N0,F433N1,F433N8
 K IB,ITF,LINE,MF,NAF,NAME,NATOTAL,PAT,PB,PBAL,PFLAG,PG,PRCA4307,PRCA433X
 K RFLAG,SDAY,SFLAG,SSN,T1,T2,T3,T4,T5,T6,T7,T8,TAMT,TBAL,TYPE,X,Y,U1N4
 QUIT
PRTTRAN3 ;
 ; Q:(CS=15)!(CS=18)!(CS=26)!(CS=27)!(CS=39)!(CS=40)!(CS=48)!(CS=49)
 Q:(CS=15)!(CS=18)!(CS=27)!(CS=40)!(CS=48)!(CS=49)
 S F433N0=$G(^PRCA(433,TRANS,0))
 S F433N1=$G(^PRCA(433,TRANS,1))
 S F433N8=$G(^PRCA(433,TRANS,8))
 S TYPE=$S($P(F433N1,U,2)'="":$P(F433N1,U,2),1:BS)
 S TAMT=$P(F433N1,U,5)
 S RFLAG="",SFLAG=""
 I "^1^12^13^43^"[("^"_TYPE_"^") S:TAMT>0 TAMT=+TAMT S RFLAG=1
 I "^2^8^9^10^11^14^26^29^34^35^41^"[("^"_TYPE_"^") S:TAMT>0 TAMT=+TAMT/-1 S RFLAG=1
 I TYPE=14,TAMT<0 S TAMT=TAMT
 S:$P(^PRCA(430,BILL,0),U,2)=26 TAMT=TAMT*-1
 S:$P(F433N1,U,2)=25 TAMT=TAMT*1
 D:$D(F433N8)'=0 CALC
 S DATE2=$S($P($P(F433N1,U,9),".")'="":$P($P(F433N1,U,9),"."),$P($P(F433N1,U,1),".")'="":$P($P(F433N1,U,1),"."),1:"")
 S TIME2="."_$S($P($P(F433N1,U,9),".",2)'="":$P($P(F433N1,U,9),".",2),$P($P(F433N1,U,1),".",2)'="":$P($P(F433N1,U,1),".",2),1:"")
 S:TIME2="." TIME2=0
 S NAF=$S(((DATE2>DATE1)!((DATE1=DATE2)&(TIME2>TIME1)))!(DATE1=""):"*",1:" ")
 S ITF=$P(F433N0,U,10)
 S ITF=$S(ITF="":" ",1:"I")
 S:($P(F433N1,U,2)=25) ITF=ITF_"R"
 S:(NAF="*")&(ITF'["I")&(ITF'["R")&(ITF'["S")&(RFLAG=1) NATOTAL=NATOTAL+TAMT S A4ANAT=NATOTAL
 S:(NAF'="*")&(ITF'["I")&(ITF'["R")&(ITF'["S")&(RFLAG=1) SRBAL=SRBAL+TAMT S A4APSB6=SRBAL
 ; S:(ITF'["I")&(ITF'["R")&(ITF'["S")&(RFLAG=1) RBAL=RBAL+TAMT S A4AFRB=RBAL
 S:(ITF'["R")&(ITF'["S")&(RFLAG=1) RBAL=RBAL+TAMT S A4AFRB=RBAL
 S DATE3=$S($P($P(F433N1,U,1),".")'=$P($P(F433N1,U,9),"."):$P($P(F433N1,U,9),"."),1:"")
 W:$G(FLAG1)=1 !,$J(TRANS,8),?10,$J($P(F433N0,U,2),6),?17,$P($P(F433N1,U,1),".")," ",DATE3,?35,$J(TYPE,4),?40,$P(F433N1,U,3),?50,$J($P(F433N1,U,4),5),?57,$J(TAMT,10,2),NAF,ITF,?70,$J(RBAL,10,2)
 I (NAF'="*")&(ITF'["I")&(ITF'["S")&(ITF'["R")&(RFLAG=1) D
   . D CALCLSB^A4AARPT3
   . S LST1=LST1+(TAMT)
   . S:TYPE=13 LST1=LST1-(TAMT)
   . S (T1,T2,T3,T4,T5)=0
   . I "^2^34^"[("^"_TYPE_"^") D
     .. D CALC4333^A4AARPT
     .. S LST1=LST1-T1-TAMT
     .. S LST2=LST2-T2
     .. S LST3=LST3-T3
     .. S LST4=LST4-T4
     .. S LST5=LST5-T5
 QUIT
CALC ;
 S BAL=0
 Q:$D(F433N8)=0
 S PRCA4338=F433N8
 S PB=$P(PRCA4338,U,1)
 S IB=$P(PRCA4338,U,2)
 S AB=$P(PRCA4338,U,3)
 S MF=$P(PRCA4338,U,4)
 S CC=$P(PRCA4338,U,5)
 S EP=$P(PRCA4338,U,7)
 S CA=$P(PRCA4338,U,8)
 S BAL=PB+IB+AB+MF+CC+EP+CA
 K PRCA4338
 QUIT
POAMT ; PROCESS ORIGINAL AMOUNT OF BILL
 D:$D(F433N8)'=0 CALC
 S DATE2=$S($P($P(F433N1,U,9),".")'="":$P($P(F433N1,U,9),"."),$P($P(F433N1,U,1),".")'="":$P($P(F433N1,U,1),"."),1:"")
 S TIME2="."_$S($P($P(F433N1,U,9),".",2)'="":$P($P(F433N1,U,9),".",2),$P($P(F433N1,U,1),".",2)'="":$P($P(F433N1,U,1),".",2),1:"")
 S:TIME2="." TIME2=0
 S NAF=$S(((DATE2>DATE1)!((DATE1=DATE2)&(TIME2>TIME1)))!(DATE1=""):"*",1:" ")
 S ITF=$P(F433N0,U,10)
 S ITF=$S(ITF="":" ",1:"I")
 S:($P(F433N1,U,2)=25) ITF=ITF_"R"
 S:(NAF="*")&(ITF'["I")&(ITF'["R")&(ITF'["S")&(RFLAG=1) NATOTAL=NATOTAL+TAMT S A4ANAT=NATOTAL
 S:(NAF'="*")&(ITF'["I")&(ITF'["R")&(ITF'["S")&(RFLAG=1) SRBAL=SRBAL+TAMT S A4APSB6=SRBAL
 ; S:(ITF'["I")&(ITF'["R")&(ITF'["S")&(RFLAG=1) RBAL=RBAL+TAMT S A4AFRB=RBAL
 S:(ITF'["R")&(ITF'["S")&(RFLAG=1) RBAL=RBAL+TAMT S A4AFRB=RBAL
 S DATE3=$S($P($P(F433N1,U,1),".")'=$P($P(F433N1,U,9),"."):$P($P(F433N1,U,9),"."),1:"")
 W:FLAG1=1 !,$J(TRANS,8),?10,$J($P(F433N0,U,2),6),?17,$P($P(F433N1,U,1),".")," ",DATE3,?35,$J(TYPE,4),?40,$P(F433N1,U,3),?50,$J($P(F433N1,U,4),5),?57,$J(TAMT,10,2),NAF,ITF,?70,$J(RBAL,10,2)
 I (NAF'="*")&(ITF'["I")&(ITF'["S")&(ITF'["R")&(RFLAG=1) D
   . D CALCLSB^A4AARPT3
   . S LST1=LST1+(TAMT)
   . S:TYPE=13 LST1=LST1-(TAMT)
   . S (T1,T2,T3,T4,T5)=0
   . I "^2^34^"[("^"_TYPE_"^") D
     .. D CALC4333^A4AARPT
     .. S LST1=LST1-T1-TAMT
     .. S LST2=LST2-T2
     .. S LST3=LST3-T3
     .. S LST4=LST4-T4
     .. S LST5=LST5-T5
 QUIT
PRTTRAN2 ;
 Q:'$D(BILL)
 S CS=$P(FAN0,U,8)
 S BS=$P(^PRCA(430.3,0),U,2)
 S RFLAG=""
 S XDATE=""
 S SFLAG=""
 Q:(CS=15)!(CS=18)!(CS=20)!(CS=27)!(CS=40)!(CS=48)!(CS=49)
 S TAMT=$P(^PRCA(430,BILL,0),U,3)
 I "^19^40^47^"[("^"_CS_"^") S:TAMT>0 TAMT=+TAMT S SFLAG=1
 S:DATE1=-1 TIME1=0
 S DATE2=$P($P($G(^PRCA(430,BILL,6)),U,21),".")
 S:DATE2="" DATE2=$P($P($G(^PRCA(430,BILL,0)),U,10),".")
 S TIME2="."_$P($P($G(^PRCA(430,BILL,6)),U,21),".",2)
 S:TIME2="." TIME2=0
 S NAF=$S(((DATE2>DATE1)!((DATE1=DATE2)&(TIME2>TIME1))):"*",(DATE2="")&(XDATE>DATE1)!(DATE1=""):"*",1:" ")
 S:NAF=("*")&(SFLAG="") NATOTAL=NATOTAL+TAMT S A4ATNA=NATOTAL
 S:NAF'=("*")&(SFLAG="") SRBAL=SRBAL+TAMT S A4APSB6=SRBAL
 S:NAF'="*" LST1=LST1+TAMT
 S:SFLAG="" RBAL=RBAL+TAMT S A4AFRB=RBAL
 S TYPE=$P(^PRCA(430.3,$P(^PRCA(430,BILL,0),U,8),0),U,2)
 S OV1=$P(^PRCA(430,BILL,0),U,10)
 S OV2=$P($P($G(^PRCA(430,BILL,6)),U,21),".")
 W:FLAG1=1 !,?10,$J(BILL,6),"*",?17,OV1," ",OV2,?35,$J(TYPE,4),?57,$J(TAMT,10,2),NAF,?70,$J(RBAL,10,2)
 QUIT
PCLDFAR ;
 S A4AFRB=RBAL
 S A4ATNA=NATOTAL
 S A4ATL4=A4APSB2+A4ATNA3
 S A4ATL8=A4APSB6+A4ATNA
 S A4ATL6=A4ATOA
 S A4ATL7=A4APSB6
 S A4ATL8=NATOTAL
 S A4ATL9=A4APSB6+NATOTAL
 S A4ATL10=RBAL
 W !,"  6. TOTAL OPEN & ACTIVE BILLS:",?50,$J(A4ATL6,10,2)
 W !,"  7. COMPUTED STATEMENT BALANCE:",?40,$J(A4ATL7,10,2)
 W !,"  8. TOTAL OF NEW ACTIVITIES:",?40,$J(A4ATL8,10,2)
 W !,"  9. TOTAL OF 2 & 3:",?50,$J(A4ATL9,10,2)
 W !," 10. FINAL RUNNING BALANCE:",?50,$J(A4ATL10,10,2)
 QUIT
