A4AMIN7 ;HINES-CIOFO/JJM - ROUTINE TO CHECK BILL BALANCE; 6/23/98 17:00
 ;;1.0;**** CLASS III ****;;JUN 30, 1998
 S RBAL=0,BAL=0
 D GETLSD^A4AARPT5
 S F430N0=$G(^PRCA(430,BILL,0))
 S CAT=$P(^PRCA(430,BILL,0),U,2)
 S CS=$P(^PRCA(430,BILL,0),U,8)
 Q:(CS=15)!(CS=18)!(CS=20)!(CS=27)!(CS=48)!(CS=49)
 S RBAL=+$P(^PRCA(430,BILL,0),U,3)
 S DATE2=$P($P($G(^PRCA(430,BILL,6)),U,21),".")
 S:DATE2="" DATE2=$P($P($G(^PRCA(430,BILL,0)),U,10),".")
 S TIME2="."_$P($P($G(^PRCA(430,BILL,6)),U,21),".",2)
 S:TIME2="." TIME2=0
 D CALCCBAL^A4AARPT
 D PTRANS
 ; W:BAL'=RBAL !,"****  INCORRECT BILL BALANCE  ****",!,BILL,"  ",$P(F430N0,U,1),"  CAT = ",$P(F430N0,U,2),"  STATUS= ",$P(F430N0,U,8)," ****"
 QUIT
PTRANS ; PROCESS BILL TRANSACTIONS
 S TRANS=""
 F  S TRANS=$O(^PRCA(433,"C",BILL,TRANS)) Q:('TRANS)  D CALCBB
 QUIT
CALCBB ;
 S BS=" "
 S F433N0=$G(^PRCA(433,TRANS,0))
 S F433N1=$G(^PRCA(433,TRANS,1))
 S F433N8=$G(^PRCA(433,TRANS,8))
 S TYPE=$S($P((F433N1),U,2)'="":$P((F433N1),U,2),1:BS)
 S TAMT=+$P((F433N1),U,5)
 S RFLAG=""
 I "^1^12^13^43^"[("^"_TYPE_"^") S:TAMT>0 TAMT=+TAMT S RFLAG=1
 I "^2^8^9^10^11^14^26^29^34^35^41^"[("^"_TYPE_"^") S:TAMT>0 TAMT=+TAMT/-1 S RFLAG=1
 I TYPE=14,TAMT<0 S TAMT=TAMT
 S:$P(^PRCA(430,BILL,0),U,2)=26 TAMT=TAMT*-1
 S:$P(F433N1,U,2)=25 TAMT=TAMT*1
 ; D:$D(F433N8)'=0 CALC
 S DATE2=$S($P($P(F433N1,U,9),".")'="":$P($P(F433N1,U,9),"."),$P($P(F433N1,U,1),".")'="":$P($P(F433N1,U,1),"."),1:"")
 S TIME2="."_$S($P($P(F433N1,U,9),".",2)'="":$P($P(F433N1,U,9),".",2),$P($P(F433N1,U,1),".",2)'="":$P($P(F433N1,U,1),".",2),1:"")
 S:TIME2="." TIME2=0
 S ITF=$P(F433N0,U,10)
 S ITF=$S(ITF="":" ",1:"I")
 S:($P(F433N1,U,2)=25) ITF=ITF_"R"
 ; S:(ITF'["I")&(ITF'["R")&(RFLAG=1) RBAL=RBAL+TAMT S A4AFRB=RBAL
 S:(ITF'["R")&(RFLAG=1) RBAL=RBAL+TAMT S A4AFRB=RBAL
 S DATE3=$S($P($P(F433N1,U,1),".")'=$P($P(F433N1,U,9),"."):$P($P(F433N1,U,9),"."),1:"")
 QUIT
CALC ;
 S BAL=0
 Q:$D(F433N8)=0
 S PRCA4338=F433N8
 S PB=$P(PRCA4338,U,1)
 S IB=$P(PRCA4338,U,2)
 S AB=$P(PRCA4338,U,3)
 S MF=$P(PRCA4338,U,4)
 S CC=$P(PRCA4338,U,5)
 S EP=$P(PRCA4338,U,7)
 S CA=$P(PRCA4338,U,8)
 S BAL=PB+IB+AB+MF+CC+EP+CA
 K PRCA4338
 QUIT
