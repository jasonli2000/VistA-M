AQASOBJ1 ; SLC/JER,KER - All Surgery Reports ; 11/02/1998
 ;COPIED FROM GMTSRO AND MODIFIED TO RETRIEVE PRE/POST DX AND
 ;OPERATIVE PROC FOR EMBEDDED OBJECT IN TIU ;5-7-99
 ;MOD: 5/12/99 - added sub to retrieve EKG results
 ;;2.7;Health Summary;**9,11,28**;Oct 20, 1995
EN(DFN,TARGET) ; Entry point for SURGERY REPORT component, includes NON-OR procedures
 ;N MAX,GMCOUNT,GMIDT,GMN,SURG,LINE
 ;N BDT,EDT
 K SURG
 N LINE
 I '$D(^SRF("B",DFN)) Q "~@"_$NA(@TARGET)
 D NOW^%DTC S EDT=X,X1=X,X2=-366 D C^%DTC S BDT=X
 S MAX=999,LINE=0 
 S GMN=0 F  S GMN=$O(^SRF("B",DFN,GMN)) Q:GMN'>0  D SORT
 I '$D(SURG) Q "~@"_$NA(@TARGET)
 S (GMCOUNT,GMIDT)=0 F  S GMIDT=$O(SURG(GMIDT)) Q:GMIDT'>0!(GMCOUNT'<MAX)  S GMN=SURG(GMIDT) D WRT 
 Q "~@"_$NA(@TARGET)
SORT ; Sort surgeries by inverted date
 ;N GMDT
 I '$D(SURG) S SURG=""
 S GMDT=$P(^SRF(GMN,0),U,9) I GMDT>BDT&(GMDT<EDT) D
 . F  Q:'$D(SURG(9999999-GMDT))  S GMDT=GMDT+.0001
 . S SURG(9999999-GMDT)=GMN
 Q
WRT ; Write surgical case record
 N X,GMI,GMDT,OPPRC,PAN,POSDX,PREDX,SPEC,STATUS,SURGEON,VER
 N DCTDTM,TRSDTM
 I $P($G(^SRF(GMN,"NON")),U)="Y" D ^AQASRON Q 
 S GMCOUNT=GMCOUNT+1
 S X=$P(^SRF(GMN,0),U,9) D REGDT4^GMTSU S GMDT=X
 D STATUS^GMTSROB S:'$D(STATUS) STATUS="UNKNOWN"
 S X=$P(^SRF(GMN,0),U,4) I X>0 S Y=X,C=$P(^DD(130,.04,0),U,2) D Y^DIQ S SPEC=Y K Y
 I $L($G(SPEC))>25 S SPEC=$$WRAP^GMTSORC(SPEC,25)
 I $D(^SRF(GMN,.1)) S X=$P(^SRF(GMN,.1),U,4) I X>0 S Y=X,C=$P(^DD(130,.14,0),U,2) D Y^DIQ S SURGEON=Y K Y
 S X=$P($G(^SRF(GMN,.3)),U) I X>0 S Y=X,C=$P(^DD(130,.31,0),U,2) D Y^DIQ S PAN=Y K Y
 S VER=$S($G(^SRF(GMN,"VER"))'="Y":"(Unverified)",1:"")
 S OPPRC(0)=$P($G(^SRF(GMN,"OP")),U,1,2) S:$P(OPPRC(0),U,2)]"" $P(OPPRC(0),U,2)=$P($$CPT^ICPTCOD($P($G(^SRF(GMN,"OP")),U,2),""),U,3) D
 . S GMI=0 F  S GMI=$O(^SRF(GMN,13,GMI)) Q:GMI'>0  S OPPRC(GMI)=$P($G(^SRF(GMN,13,GMI,0)),U)_U_$G(^SRF(GMN,13,GMI,2)) S:$P(OPPRC(GMI),U,2)]"" $P(OPPRC(GMI),U,2)=$P($$CPT^ICPTCOD($P($G(^SRF(GMN,13,GMI,2)),U),""),U,3)
 S X=$P($G(^SRF(GMN,31)),U,6) I X>0 D REGDTM4^GMTSU S DCTDTM=X
 S X=$P($G(^SRF(GMN,31)),U,7) I X>0 D REGDTM4^GMTSU S TRSDTM=X
 S LINE=LINE+1,@TARGET@(LINE,0)=" Surgery Date: "_GMDT
 ;S LINE=LINE+1,@TARGET@(LINE,0)=" Pre-op DX: "
 ;S GMI="" F  S GMI=$O(PREDX(GMI)) Q:GMI=""  S PREDX=$S($L(PREDX(GMI))'>58:PREDX(GMI),1:$$WRAP^GMTSORC(PREDX(GMI),58)) F GMJ=1:1:$L(PREDX,"|")  D
 ;.S LINE=LINE+1,@TARGET@(LINE,0)=$S(GMJ=1:21,1:22)_" "_$P(PREDX,"|",GMJ)
 ;.S:GMJ=1&(PREDX?1.A.E) @TARGET@(LINE,0)=@TARGET@(LINE,0)_" "_VER
 ;S LINE=LINE+1,@TARGET@(LINE,0)=" Post-op Dx: "
 ;S GMI="" F  S GMI=$O(POSDX(GMI)) Q:GMI=""  S POSDX=$S($L(POSDX(GMI))'>58:POSDX(GMI),1:$$WRAP^GMTSORC(POSDX(GMI),58)) F GMJ=1:1:$L(POSDX,"|")  D
 ;.S LINE=LINE+1,@TARGET@(LINE,0)=$S(GMJ=1:21,1:22)_$P(POSDX,"|",GMJ)
 ;.S:GMJ=1&(POSDX?1.A.E) @TARGET@(LINE,0)=@TARGET@(LINE,0)_" "_VER
 S LINE=LINE+1,@TARGET@(LINE,0)=" Operative Proc(s): "
 S GMI="" F  S GMI=$O(OPPRC(GMI)) Q:GMI=""  S OPPRC=$S($L($P(OPPRC(GMI),U))'>58:OPPRC(GMI),1:$$WRAP^GMTSORC($P(OPPRC(GMI),U),58)_U_$P(OPPRC(GMI),U,2)) F GMJ=1:1:$L($P(OPPRC,U),"|") D WRTPRC 
 Q
WRTPRC ; Writes operative procedures
 S LINE=LINE+1,@TARGET@(LINE,0)=$S(GMJ=1:21,1:22)_" "_$P($P(OPPRC,U),"|",GMJ)
 S:GMJ=1&($P(OPPRC,U,2)]"") @TARGET@(LINE,0)=@TARGET@(LINE,0)_" - "_$P(OPPRC,U,2)
 Q
PROC(DFN,TYPE,TARGET) ; retrieve Procedure results
 D GETDT
 S EDT=EDT-1
 N LINE S LINE=0,CNT=0
 S FL=$S(TYPE="EKG":691.5,TYPE="PFT":700,TYPE="EEG":699.5,TYPE="ECHO":699.5,1:691.5)
 I TYPE="EKG" K ^TMP("EKG")
 I TYPE="PFT" K ^TMP("PFT")
 I TYPE="EEG" K ^TMP("EEG")
 I TYPE="ECHO" K ^TMP("ECHO")
 S BD=EDT F J=1:1:MAX S BD=$O(^MCAR(690,"AC",DFN,BD)) Q:BD=""!(BD>BDT)  D LOC
 I '$D(ARY(DFN)) S @TARGET@(1,0)="No data available"
 Q "~@"_$NA(@TARGET)
LOC ;
 S J1="" F K=1:1 S J1=$O(^MCAR(690,"AC",DFN,BD,J1)) Q:J1=""  D
 .I J1'[FL Q
 .S J2="",FLG=0 F L=1:1 S J2=$O(^MCAR(690,"AC",DFN,BD,J1,J2)) Q:J2=""!(CNT=MAX)  D
 ..I TYPE="EKG" D EKG Q
 ..I TYPE="PFT" D PFT Q
 ..I TYPE="EEG" D EEG Q
 ..I TYPE="ECHO" D ECHO Q
 Q
EKG ;
 I '$D(^MCAR(691.5,J2)) Q
 I $P(^MCAR(691.5,J2,0),U,2)'=DFN Q
 S CNT=CNT+1
 S ARY(DFN)=""
 S REC=$G(^MCAR(691.5,J2,8))
 S Y=$P(^MCAR(691.5,J2,0),U) X ^DD("DD") S LINE=LINE+1,@TARGET@(LINE,0)="PROCEDURE DATE/TIME: "_Y
 S LINE=LINE+1,@TARGET@(LINE,0)="INSTRUMENT DX: "_$G(^MCAR(691.5,J2,9,1,0))
 S I=1 F  S I=$O(^MCAR(691.5,J2,9,I)) Q:I'>0!(I="")  D
 ..S LINE=LINE+1,@TARGET@(LINE,0)=$G(^MCAR(691.5,J2,9,I,0))
 Q
PFT ;  retrieve PFT results
 I '$D(^MCAR(700,J2)) Q
 I $P(^MCAR(700,J2,0),U,2)'=DFN Q
 S CNT=CNT+1
 S ARY(DFN)=""
 S REC=$G(^MCAR(700,J2,.2))
 S Y=$P(^MCAR(700,J2,0),U) X ^DD("DD") S LINE=LINE+1,@TARGET@(LINE,0)="PROCEDURE DATE/TIME: "_Y
 S LINE=LINE+1,@TARGET@(LINE,0)="PROCEDURE SUMMARY: "_$P(REC,U,2)
 Q
EEG ;
 I '$D(^MCAR(699.5,J2)) Q
 I $P(^MCAR(699.5,J2,0),U,2)'=DFN Q
 S FLG=0
 S REC=$G(^MCAR(699.5,J2,0))
 I $P(REC,U,8)']"" Q
 S IEN=$P(REC,U,8)
 I $P(^MCAR(697.2,IEN,0),U)["EEG"!($P(^MCAR(697.2,IEN,0),U)["ELECTROMYO") S FLG=1
 I 'FLG Q
 S CNT=CNT+1
 S ARY(DFN)=""
 S Y=$P(^MCAR(699.5,J2,0),U) X ^DD("DD") S LINE=LINE+1,@TARGET@(LINE,0)="PROCEDURE DATE/TIME: "_Y
 I '$D(^MCAR(699.5,J2,21,0))  S LINE=LINE+1,@TARGET@(LINE,0)="Missing report." Q
 S A=0 F  S A=$O(^MCAR(699.5,J2,21,A)) Q:'A  D
 .S REC=$G(^MCAR(699.5,J2,21,A,0))
 .I REC'["IMPRESSION" Q
 .S LINE=LINE+1,@TARGET@(LINE,0)=REC
 Q
ECHO ;
 I '$D(^MCAR(699.5,J2)) Q
 I $P(^MCAR(699.5,J2,0),U,2)'=DFN Q
 S FLG=0
 S REC=$G(^MCAR(699.5,J2,0))
 I $P(REC,U,8)']"" Q
 S IEN=$P(REC,U,8)
 I $P(^MCAR(697.2,IEN,0),U)["G-ECHO" S FLG=1
 I 'FLG Q
 S CNT=CNT+1
 S ARY(DFN)=""
 S Y=$P(^MCAR(699.5,J2,0),U) X ^DD("DD") S LINE=LINE+1,@TARGET@(LINE,0)="PROCEDURE DATE/TIME: "_Y
 I '$D(^MCAR(699.5,J2,22,0)) S LINE=LINE+1,@TARGET@(LINE,0)="Missing Report." Q
 S A=0 F  S A=$O(^MCAR(699.5,J2,22,A)) Q:'A  D
 .S REC=$G(^MCAR(699.5,J2,22,A,0))
 .I REC'["EJECTION FRACTION" Q
 .S REC=$P(REC,":",2),REC=$TR(REC," ","")
 .S LINE=LINE+1,@TARGET@(LINE,0)=REC
 Q
GETDT ;
 D NOW^%DTC S EDT=X,X1=X,X2=-365 D C^%DTC S BDT=X
 S EDT=9999999.99999-EDT,BDT=9999999.99999-(BDT-1)
 S MAX=5
 Q
