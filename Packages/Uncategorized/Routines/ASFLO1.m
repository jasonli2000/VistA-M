ASFLO1 ;ROUTINE #2 - TO GATHER INFORMATION FOR LOCALLY CREATED OBJECTS - LOCAL COUNTERPART TO TIULO
 ;;V1.0 GDM/SYR 1/29/98
CALCIUM(DFN) ;GETS PAT'S LAST CALCIUM
 S LRDFN=$P(^DPT(DFN,"LR"),"^"),X="Not Found"
 S CALC="" S NODE="^LR(LRDFN,""CH"")" F  S NODE=$Q(@NODE) Q:NODE=""  S CHK=$P(NODE,",",4),CHK=$E(CHK,1,($L(CHK)-1)) I CHK=671458 I $P(@NODE,"^",1)'?.A S X=$P(@NODE,"^",1) Q
 Q $S(X]"":X,1:"Not Listed")
 ;
PO4(DFN) ;GETS LAST PHOSPHORUS DONE
 S LRDFN=$P(^DPT(DFN,"LR"),"^"),X="Not Found"
 S NODE="^LR(LRDFN,""CH"")" F  S NODE=$Q(@NODE) Q:NODE=""  S CHK=$P(NODE,",",4),CHK=$E(CHK,1,($L(CHK)-1)) I CHK=10 I $P(@NODE,"^",1)'?.A S X=$P(@NODE,"^",1) Q
 Q $S(X]"":X,1:"Not Listed")
 ;
T4(DFN) ;GETS LAST T4 MEASUREMENT
 S LRDFN=$P(^DPT(DFN,"LR"),"^"),X="Not Found"
 S NODE="^LR(LRDFN,""CH"")" F  S NODE=$Q(@NODE) Q:NODE=""  S CHK=$P(NODE,",",4),CHK=$E(CHK,1,($L(CHK)-1)) I CHK=670427 I $P(@NODE,"^",1)'?.A S X=$P(@NODE,"^",1) Q
 Q $S(X]"":X,1:"Not Listed")
 ;
TSH(DFN) ;GETS LAST TSH LEVEL
 S LRDFN=$P(^DPT(DFN,"LR"),"^")
 S NODE="^LR(LRDFN,""CH"")" F  S NODE=$Q(@NODE) Q:NODE=""  S CHK=$P(NODE,",",4),CHK=$E(CHK,1,($L(CHK)-1)) I CHK=670433 I $P(@NODE,"^",1)'?.A S X=$P(@NODE,"^",1) Q
 Q $S(X]"":X,1:"Not Listed")
 ;
FOLIC(DFN) ;GETS LAST FOLIC ACID
 S LRDFN=$P(^DPT(DFN,"LR"),"^")
 S NODE="^LR(LRDFN,""CH"")" F  S NODE=$Q(@NODE) Q:NODE=""  S CHK=$P(NODE,",",4),CHK=$E(CHK,1,($L(CHK)-1)) I CHK=670833 I $P(@NODE,"^",1)'?.A S X=$P(@NODE,"^",1) Q
 Q $S(X]"":X,1:"Not Listed")
 ;
GUIAC(DFN) ;GETS LAST STOOL GUIAC
 S LRDFN=$P(^DPT(DFN,"LR"),"^")
 S NODE="^LR(LRDFN,""CH"")" F  S NODE=$Q(@NODE) Q:NODE=""  S CHK=$P(NODE,",",4),CHK=$E(CHK,1,($L(CHK)-1)) I CHK=670002 I $P(@NODE,"^",1)'?.A S X=$P(@NODE,"^",1) Q
 Q $S(X]"":X,1:"Not Listed")
 ;
 ;
INPT(TARGET,WHAT) ;GETS INPATIENT MEDICATIONS - PAUL SHANAHAN FORMAT
 S ICNT=0,LINE=$S('$D(LINE):0,1:LINE) D
 .S LINE=LINE+1,INPTLINE=LINE,@TARGET@(LINE,0)="       INPT MEDICATIONS:"
 .S LINE=LINE+1,@TARGET@(LINE,0)=""
 ;.SS LINE=LINE+1,@TARGET@(LINE,0)="          DRUG                    DOSE           STATUS    SIG"
 ;.SS LINE=LINE+1,@TARGET@(LINE,0)="          ----                    ----           ------    ---"
 I $O(^PS(55,DFN,5,0)) S XREF=0 F I=0:0 S XREF=$O(^PS(55,DFN,5,XREF)) Q:XREF="AU"  S ORD=^PS(55,DFN,5,XREF,0) I $P(ORD,"^",9)="A" S PROV=$P(ORD,"^",2) D WRITEI
 I 'ICNT D
 .S @TARGET@(INPTLINE,0)=@TARGET@(LINE,0)_"NONE"
 .F II=INPTLINE+2:1:INPTLINE+4 K @TARGET@(II,0)
 Q "~@"_$NA(@TARGET)
WRITEI S SIG=$P(^PS(55,DFN,5,XREF,2),"^"),ASFD=$P(^PS(55,DFN,5,XREF,1,1,0),"^",1),DOSE=$P(^(0),"^",2) S K=$S($L(SIG)>20:3,1:2)
 S ASFDRUG=$P(^PSDRUG(ASFD,0),"^",1) S ASFDRUG=$E(ASFDRUG,1,30)
 S ICNT=ICNT+1,LINE=LINE+1 D SIG^TIUZPSOB D
 .S @TARGET@(LINE,0)=ASFDRUG
 .S LINE=LINE+1,@TARGET@(LINE,0)="  SIG: "_DOSE_" "_SIG
 S LINE=LINE+1,@TARGET@(LINE,0)="  # DAYS WORTH OF MEDICINE _________"
 S LINE=LINE+1,@TARGET@(LINE,0)="              # OF REFILLS _________"
 S LINE=LINE+1,@TARGET@(LINE,0)=""
 Q
 S LRDFN=$P(^DPT(DFN,"LR"),"^")
 S NODE="^LR(LRDFN,""CH"")" F  S NODE=$Q(@NODE) Q:NODE=""  S CHK=$P(NODE,",",4),CHK=$E(CHK,1,($L(CHK)-1)) I CHK=8 I $P(@NODE,"^",1)'?.A S X=$P(@NODE,"^",1) Q
 Q $S(X]"":X,1:"Not Listed")
 ;
BMI(DFN) ;GETS LAST BODY MASS INDEX - GETS DFN FROM APPLICATION
 S (TYP,GMRBMI)="" F  S TYP=$O(^GMR(120.5,"AA",DFN,TYP)) Q:TYP=""  S:TYP=8 RECDT=$O(^GMR(120.5,"AA",DFN,TYP,"")),HTIFN=$O(^GMR(120.5,"AA",DFN,TYP,RECDT,"")) S:TYP=9 RECDT=$O(^GMR(120.5,"AA",DFN,TYP,"")),WTIFN=$O(^GMR(120.5,"AA",DFN,TYP,RECDT,""))
 I $D(WTIFN) I $D(HTIFN) S HT=$P(^GMR(120.5,HTIFN,0),"^",8),HT1=HT*HT S WT=$P(^GMR(120.5,WTIFN,0),"^",8) S GMRBMI=(WT/HT1)*705,GMRBMI=$J(GMRBMI,2,0)
 K TYPE,RECDT,WTIFN,HTIFN Q $S(GMRBMI]"":GMRBMI,1:"Appropriate Measurements not Available")
 ;-----------------------------------------
FUT(TARGET,DFN) ;GETS FUTURE APPOINTMENTS
 K ^TMP($J) S LINE=0 S LINE=LINE+1 S @TARGET@(LINE,0)="          ** ALL FUTURE APPOINTMENTS **" S LINE=LINE+1,@TARGET@(LINE,0)="      DATE/TIME              CLINIC ( LOCATION )"
 S XRF=DT_".9" I $N(^DPT(DFN,"S",XRF)) F I=0:0 S XRF=$O(^DPT(DFN,"S",XRF)) Q:XRF=""  S Y=XRF,(CLI,L)=$P(^DPT(DFN,"S",XRF,0),"^") I $S($P(^DPT(DFN,"S",XRF,0),"^",2)']"":1,$P(^(0),"^",2)="I":1,1:0) D LOC^ASFFUT S CLI=$P(^SC(CLI,0),"^") X ^DD("DD") D
 .S CLI=$E(CLI,1,25)
 .S LINE=LINE+1 S @TARGET@(LINE,0)="   "_Y_"    "_CLI_"  "_"("_SDLOC_")"
 ;S M=SDM K SDN,SDI
 ;S L=+^DPT(DFN,"S",M,0) D LOC^ASFFUT S X=M D TM^ASFFUT S Y=M D DTS^SDUTL S LINE=LINE+1 S @TARGET@(LINE,0)="      "_Y_"   "_$J(X,8)_"      "_$P(^SC(L,0),"^",1)_"  "_SDLOC
 Q "~@"_$NA(@TARGET)
 ;
DIET(DFN) ;GETS THE CURRENT DIET
 S WARD="",FLAG=0 F  S WARD=$O(^DPT("CN",WARD)) Q:WARD=""  S IFN="" F  S IFN=$O(^DPT("CN",WARD,IFN)) Q:IFN=""!(FLAG=1)  I IFN=DFN S ADM=^DPT("CN",WARD,IFN) S FLAG=1
 I FLAG=1 D CUR^FHORD7 S X=Y
 K FLAG,WARD,IFN Q $S(X]"":X,1:"Not Listed")
 ;
POLY(DFN) ;GETS WBC AND NEUTROPHILS AND CALCULATES POLYS
 S LRDFN=$P(^DPT(DFN,"LR"),"^")
 S WBC="" S NODE="^LR(LRDFN,""CH"")" F  S NODE=$Q(@NODE) Q:NODE'[LRDFN!(WBC]"")  S CHK=$P(NODE,",",4),CHK=$E(CHK,1,($L(CHK)-1)) I CHK=394 S SEQ=$P(@NODE,"^",1) I $E(SEQ,1,1)'?.A S SEQ1=SEQ D  I WBC]"" Q
 .S INTDT=$P(NODE,",",3) I $D(^LR(LRDFN,"CH",INTDT,384)) S WBC=$P(^LR(LRDFN,"CH",INTDT,384),"^")
 .I $D(^LR(LRDFN,"CH",INTDT,395)) S BANDS=$P(^LR(LRDFN,"CH",INTDT,395),"^")
 S X="" I $D(SEQ1)&($D(WBC)) I '$D(BANDS) S X=(SEQ1*WBC*10),X=$J(X,4,1)_" Cells/ml"
 I $D(SEQ1)&$D(BANDS)&$D(WBC) S X=((SEQ1+BANDS)*WBC*10),X=$J(X,4,1)_" Cells/ml"
 K SEQ,SEQ1,WBC,BANDS,INTDT
 Q $S(X]"":X,1:"Not Available")
PROB(DFN,TARGET,LINE) ;GET PATIENTS PROBLEMS
 S LINE=0 S (XREF,PROB)="" F  S XREF=$O(^AUPNPROB("AC",DFN,XREF)) Q:XREF=""  D
 .S PROB=$P(^AUPNPROB(XREF,0),"^",5) S STAT=$P(^AUPNPROB(XREF,0),"^",12) I STAT="A" S PROB=$P(^AUTNPOV(PROB,0),"^") S LINE=LINE+1 S @TARGET@(LINE,0)=PROB I LINE>1 S @TARGET@(LINE,0)="               "_PROB
 Q "~@"_$NA(@TARGET)
 ;
PNOK(DFN) ;GET PRIMARY NEXT OF KIN
 S PNOK="None Listed" I $P(^DPT(DFN,.21),"^",1)'="" S PNOK=$P(^(.21),"^")
 Q $S(PNOK]"":PNOK,1:"None Listed")
 ;
HBA1C(DFN,TARGET,LINE) ;GETS LAST 3 HEMOGLOBIN A1C VALUES
 S CNT=0 S LRDFN=$P(^DPT(DFN,"LR"),"^") S NODE="^LR(LRDFN,""CH"")" F  S NODE=$Q(@NODE) Q:NODE'[LRDFN!(CNT=3)  S CHK=$P(NODE,",",4) S CHK=$E(CHK,1,($L(CHK)-1)) I CHK=462 I $P(@NODE,"^",1)'?.A S LINE=LINE+1 D
 .S DATE=$P(^LR(LRDFN,"CH",$P(NODE,",",3),0),"^"),DATE=$P(DATE,".",1) S Y=DATE X ^DD("DD") S DATE=Y S @TARGET@(LINE,0)=DATE_"  -  "_$P(@NODE,"^",1) S CNT=CNT+1 I CNT>1 S @TARGET@(LINE,0)="                 "_DATE_"  -  "_$P(@NODE,"^",1)
 Q "~@"_$NA(@TARGET)
 
