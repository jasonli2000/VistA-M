PRMRSEMI ;GLRISC/JES-SEMI-ANNUAL REPORTS (RCS 10-0073) ; 2/3/89  12:42 ;
 ;VERSION: 1.0
 S:'$D(DTIME)#2 DTIME=300 S:DTIME=0 DTIME=300 S HIT=""
 G START
BLURBQ ;
 W !!,"Enter Quarter Period in this format: 2nd quarter 1988 would be 2-88 or 2/88",!! Q
START ;
 W !!,"Enter Quarter Period and FY you wish Semi-Annual Report to end with:",!
ONLY14 ;
 R "(Format: 2/88 or 2-88 for 2nd quarter FY 1988): ",QUART:DTIME G:'$T QUIT
 I QUART["?" D BLURBQ G ONLY14
 Q:(QUART="")!(QUART="^")  I (QUART'?1N1"-"2N)&(QUART'?1N1"/"2N) D BLURBQ G ONLY14
 I ($E(QUART,1)>4)!($E(QUART,1)<1) W !!,"Enter Quarter 1 to 4 only",!! G ONLY14
 S %ZIS="QM" D ^%ZIS K %ZIS K:POP IO("Q") G:POP QUIT
 I $D(IO("Q")) K IO("Q") S ZTIO=ION,ZTRTN="EN^PRMRSEMI",ZTDESC="Semi-Annual Incident Report",ZTSAVE("QUART")="",ZTSAVE("HIT")="" D ^%ZTLOAD K ZTSK,ZTIO G QUIT
 G EN
 Q
EN ;
 U IO S QU=$E(QUART,1),YR=$E(QUART,3,4)
 I QU=1 S ONEBEG=2_YR-1_"0701.0001",ONEEND=2_YR-1_"0930.9999",TWOBEG=2_YR-1_"1001.0001",TWOEND=2_YR-1_"1231.9999" G BUILD
 I QU=2 S ONEBEG=2_YR-1_"1001.0001",ONEEND=2_YR-1_"1231.9999",TWOBEG=2_YR_"0101.0001",TWOEND=2_YR_"0331.9999" G BUILD
 I QU=3 S ONEBEG=2_YR_"0101.0001",ONEEND=2_YR_"0331.9999",TWOBEG=2_YR_"0401.0001",TWOEND=2_YR_"0650.9999" G BUILD
 S:QU=4 ONEBEG=2_YR_"0401.0001",ONEEND=2_YR_"0650.9999",TWOBEG=2_YR_"0701.0001",TWOEND=2_YR_"0930.9999"
BUILD ;
 S Y=$E(ONEEND,1,7) X ^DD("DD") S QUENG=Y S Y=$E(TWOEND,1,7) X ^DD("DD") S SEENG=Y,N=0,C=$P(^PRMQ(513.941,0),"^",4)
 F I=1:1:C S N=$O(^PRMQ(513.941,N)),TYPE=$P(^PRMQ(513.941,N,0),"^",1),(TARRAY(1,TYPE),TARRAY(2,TYPE))="0^"_$P(^(0),"^",2),(TOT(1,+TYPE),TOT(2,+TYPE))=0
 S TARRAY(1,109)="0^Patient injury-misc",TARRAY(2,109)="0^Patient injury-misc"
 S (TOT1,TOT2)=0,N=0 F I=0:0 S N=$O(^PRMQ(513.72,N)) Q:N'?1.N  I $D(^PRMQ(513.72,N,"I")) D RANGE I OK S TYPE=$P(^PRMQ(513.941,^PRMQ(513.72,N,"I"),0),"^",1),$P(TARRAY(Q,TYPE),"^",1)=$P(TARRAY(Q,TYPE),"^",1)+1
 S TYPE=""
 F I=0:0 S TYPE=$O(TARRAY(1,TYPE)) Q:(TYPE=115)!(TYPE="")  D SET1
 S TYPE=""
 F I=0:0 S TYPE=$O(TARRAY(2,TYPE)) Q:(TYPE=115)!(TYPE="")  D SET2
 D HEAD1
 W !?1,"QUARTER ENDING: ",QUENG,! S TYPE="" F I=0:0 S TYPE=$O(TOT(1,TYPE)) Q:(TYPE="")!(TYPE=115)!(+TYPE'=TYPE)  W !?1,TYPE,?6,$P(TARRAY(1,TYPE),"^",2),?65,$J(TOT(1,TYPE),4,0) S TOT1=TOT1+TOT(1,TYPE)
 D:$E(IOST)="C" HEAD G:HIT["^" QUIT S TYPE="114Z" F I=0:0 S TYPE=$O(TARRAY(1,TYPE)) Q:TYPE=""  W !?1,TYPE,?6,$P(TARRAY(1,TYPE),"^",2),?65,$J(+TARRAY(1,TYPE),4,0) S TOT1=TOT1+TARRAY(1,TYPE)
 W !?6,"TOTAL FOR QUARTER ENDING ",QUENG,?65,$J(TOT1,4,0)
REPORT D HEAD G:HIT["^" QUIT
 W !?1,"QUARTER ENDING: ",SEENG,!
 S TYPE="" F I=0:0 S TYPE=$O(TOT(2,TYPE)) Q:(TYPE="")!(TYPE=115)!(+TYPE'=TYPE)  W !?1,TYPE,?6,$P(TARRAY(2,TYPE),"^",2),?65,$J(TOT(2,TYPE),4,0) S TOT2=TOT2+TOT(2,TYPE)
 D:$E(IOST)="C" HEAD G:HIT["^" QUIT S TYPE="114Z" F I=0:0 S TYPE=$O(TARRAY(2,TYPE)) Q:TYPE=""  W !?1,TYPE,?6,$P(TARRAY(2,TYPE),"^",2),?65,$J(+TARRAY(2,TYPE),4,0) S TOT2=TOT2+TARRAY(2,TYPE)
 G:HIT["^" QUIT W !?6,"TOTAL FOR QUARTER ENDING ",SEENG,?65,$J(TOT2,4,0),!?6,"GRAND TOTAL: ",?65,$J(TOT1+TOT2,4,0)
 I $E(IOST)="C" W !!,*7,"Press return to continue or ""^"" to escape " R HIT:DTIME
QUIT ;
 W @IOF,@IOF X ^%ZIS("C") K:$D(ZTSK) ^%ZTSK(ZTSK) K C,GOT,HIT,I,N,OK,POP,QUART,ONEBEG,ONEEND,QUENG,SEENG,Q,QU,RDATE,TARRAY,TOT,TWOBEG,TWOEND,TYPE,Y,YR,TOT,TOT1,TOT2
 Q
RANGE ;
 S OK=0,RDATE=$P(^PRMQ(513.72,N,0),"^",1) I ((RDATE=ONEBEG)!(RDATE>ONEBEG))&((RDATE=TWOEND)!(RDATE<TWOEND)) S (OK,Q)=1 S:(RDATE=TWOBEG)!(RDATE>TWOBEG) Q=2 Q
 E  Q
SET1 ;
 S TOT(1,+TYPE)=TOT(1,+TYPE)+TARRAY(1,TYPE)
 Q
SET2 ;
 S TOT(2,+TYPE)=TOT(2,+TYPE)+TARRAY(2,TYPE)
 Q
HEAD ;
 S HIT="" I $E(IOST)="C" W !?2,*7,"Press return to continue or ""^"" to escape " R HIT:DTIME S:'$T HIT="^" Q:HIT["^"
HEAD1 S Y=DT X ^DD("DD") W @IOF,!!?30,"INCIDENT REPORTS",?65,"RCS 10-0073",!?20,"SEMI-ANNUAL PERIOD ENDING ",SEENG,?65,Y,! F I=1:1:80 W "-"
