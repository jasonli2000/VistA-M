SWCNHCFY ;DLG/FARGO;ML/BHAM;HANDLE FISCAL YEAR CHANGE;12/29/85
 ;VERSION 1.0;RUN UPDATE FOR FISCAL YEAR CHANGE ON ACTIVE RECORDS
 ;INITIALIZE;SWLIM IS LAST RECORD IN FILE.
 I DT<(($P(^SOWK(657,$P(^SOWK(657,0),U,3),0),U,9)+200)_"1001") W !,"CANNOT RUN BEFORE THE END OF THE FISCAL YEAR!!",! Q
 S N=0,SWLIM=$P(^SOWK(657,0),U,3)
 ;LOOP FILE LOOKING FOR ACTIVE RECORDS, CLOSE THESE, OPEN NEW FY ENTRY
L S N=$N(^SOWK(657,N)) G DONE:(N<0)!(N["B")!(N>SWLIM),L:$P(^SOWK(657,N,0),U,10)'["A"
 S X1=$P(^SOWK(657,N,0),U,12),SWCT=$P(^(0),U,4),X2=$S(SWCT["A":365,SWCT["B":180,1:90) D C^%DTC I X<($E($P(^(0),U,13),1,3)_"1001") S $P(^(0),U,10)="C",$P(^(0),U,13)=X G L
 L ^SOWK(657) S SWSEQ=$P(^SOWK(657,0),U,3)+1,SWNUM=$P(^(0),U,4)+1 S ^(0)=$P(^(0),U,1,2)_"^"_SWSEQ_"^"_SWNUM L
 S %X="^SOWK(657,"_N_",",%Y="^SOWK(657,"_SWSEQ_"," D %XY^%RCR
 S $P(^SOWK(657,N,0),U,10)="C",$P(^(0),U,13)=$E($P(^(0),U,13),1,3)_"0930"
 S ^SOWK(657,"B",$P(^SOWK(657,SWSEQ,0),U,1),SWSEQ)="",SWCN=$P(^SOWK(657,SWSEQ,0),U,2),SWCN=+SWCN_$C($A($E(SWCN,$L(SWCN),$L(SWCN)))+1)
 S:+$A($E(SWCN,$L(SWCN),$L(SWCN)))<58 SWCN=$E(SWCN,1,($L(SWCN)-1))_"A"
 S ^SOWK(657,"C",SWCN,SWSEQ)="",$P(^SOWK(657,SWSEQ,0),U,2)=SWCN,$P(^(0),U,9)=($P(^(0),U,9)+1),$P(^(0),U,12)=$E($P(^(0),U,12),1,3)_"1001"
 S ^SOWK(657,"FYN",$P(^(0),U,9)_"-"_$P(^DPT($P(^SOWK(657,SWSEQ,0),U,1),0),U,1)_"-"_SWCN,SWSEQ)=""
 ;CHECK IF ASIH AND ADJUST RECORDS ACCORDINGLY
 K ^SOWK(657,SWSEQ,4),^(3)
 I $D(^SOWK(657,N,4)) S SWA=$P(^(4,0),U,3) I $P(^(SWA,0),U,2)="" S $P(^SOWK(657,N,4,SWA,0),U,2)=$P(^SOWK(657,N,0),U,13),^SOWK(657,SWSEQ,4,0)="^657.04D^1^1",^SOWK(657,SWSEQ,4,1,0)=$P(^SOWK(657,SWSEQ,0),U,12)
 S J=0,SWCN=+SWCN
 ;CHECK FOR FIRST ENTRY DATE FOR CASE ADD CONTRACT LENGTH TO GET END DATE
N S J=$N(^SOWK(657,"C",SWCN,J)) G L:J<0 I $P(^SOWK(657,J,0),U,9)'=$P(^SOWK(657,N,0),U,9) S SWCN=+SWCN_$C($A($E(SWCN,$L(SWCN),$L(SWCN)))+1) S:$A($E(SWCN,$L(SWCN),$L(SWCN)))<58 SWCN=$E(SWCN,1,($L(SWCN)-1))_"A" S J=0 G N
 S X1=$P(^SOWK(657,J,0),U,12),SWCT=$P(^SOWK(657,SWSEQ,0),U,4),X2=$S(SWCT["A":365,SWCT["B":180,1:90) D C^%DTC
 S:SWCT["A" X=($E($P(^SOWK(657,SWSEQ,0),U,12),1,3)+1)_"0930" S $P(^SOWK(657,SWSEQ,0),U,13)=X G L
DONE K %CHK,%H,%RET,J,N,QQ,SWA,SWCN,SWCT,SWLIM,SWNUM,SWSEQ,X,%X,%Y,X1,X2 Q
