ZDDUTIL1 ;PROGRAM TO MANIPULATE SOME DD ITEMS ;8/7/96  09:16
SENDD ;
 ;SEND THE DATA DICTIONARY
 ;
 ;S X="|SENDD|100|",IO=$I
 D CLEARCOM S MSG=""
 S FILENUM="",FILENAME=""
 K PFN
 S FILENUM=$P(X,"|",3),ORIGFN=FILENUM D FIELDS^ZDDUTIL
ENTR S REFGL="^DIC("_FILENUM_",0,"_$C(34)_"GL"_$C(34)_")"
 S REFNODE=@REFGL,REFNODE=REFNODE_"0)" ;FIND NUMBER OF ENTRIES
 S ENTRIES=$P($G(@REFNODE),"^",4)
 U IO W "|STARTDD|",!
 S FILENAME=$P($G(^TMP($J,"GLOBAL DATA")),"^",1)
 S FNAME=FILENAME
 I FILENAME[" " S NUMSP=$L(FILENAME," ")-1 F II=1:1:NUMSP S FNAME=$TR(FILENAME," ","_")
 I FNAME["&" S FNAME=$TR(FNAME,"&","_") ;8/26/97-AMT
 S SHORTNM=$E(FILENAME,1,8)
 W "|DBASEDEF|"_ORIGFN_"|"_SHORTNM_"|",!
 W "|TABLEDEF|"_ORIGFN_"|*|"_FNAME_"|",!
 ;W FILENUM," FILENAME=",FILENAME
 ;SEND TO PC
 D FILENUMX 
 W "**ENDTX**",!
 K PFN,FILEX,FLDX,FIELDNAM,FIELDLEN
 Q
FILENUMX ;LOOP THRU THE BEGINNING FILENUMBER PLUS ALL MULTIPLES
 S FILEX=FILENUM-.001
 F  S FILEX=$O(^TMP($J,FILEX)) Q:FILEX=""  D FIELDX
 ;PROCESS ANY POINTER FILES-MUST CREAT SEPARATE TABLES
 Q
 ;I $D(PFN)=0 Q  ;NO POINTERS
 ;
 ;S PFILE=""
 ;F  S PFILE=$O(PFN(PFILE)) Q:PFILE=""  D  ;PROCESS ALL POINTER FILES
 ;.S Y=$G(^DD(PFILE,.01,0)),Z=$P(Y,"^",5)
 ;.S X=$P(Z,">",2),X=$P(X,"!",1),PFNLEN=X
 ;.S TABLENAM=$O(^DD(PFILE,0,"NM",""))
 ;.S NUMSP=$L(TABLENAM," ")-1 F II=1:1:NUMSP S TABLENAM=$TR(TABLENAM," ","_")
 ;.S PFNAME=$P(Y,"^",1),PFTYPE=$P(Y,"^",2)
 ;.S PFNAME=$L(PFNAME," ")-1 F II=1:1:NUMSP S PFNAME=$TR(PFNAME," ","_")
 ;.S YY=PFN(PFILE)
 ;.S PNUMKEY=$P(YY,"^",2) 
 ;.W "|TABLEDEF|"_PFILE_"|*|"_TABLENAM_"|",! ;*-FIELDNUM-NO MULTIPLES
 ;.W "|FIELDEF|"_PFILE_"|.01|"_PFNAME_"|"_PFTYPE_"|"_PFNLEN_"|"_PFILE_"|"_PNUMKEY_"|",!
 ;K YY,U,X,PFNLEN,TABLENAM,PFNAME,PFTYPE,PFILE
 ;Q
FIELDX ;LOOP THRU ALL FIELDS AT A GIVEN LEVEL
 S FLDX=""
 F  S FLDX=$O(^TMP($J,FILEX,FLDX)) Q:FLDX=""  D OUTFLD
 Q
OUTFLD ;GOT ALL THE DATA NEEDED FOR PC
 ;W !,"FILEX=",FILEX," FLDX=",FLDX
 S Y=$G(^TMP($J,FILEX,FLDX)),FIELDNAM=$P(Y,"^",1),FIELDLEN=$P(Y,"^",3)
 S NUMSP=$L(FIELDNAM," ")-1 F II=1:1:NUMSP S FIELDNAM=$TR(FIELDNAM," ","_")
 S NUMSP=$L(FIELDNAM,"/")-1 F II=1:1:NUMSP S FIELDNAM=$TR(FIELDNAM,"/","_")
 S NUMSP=$L(FIELDNAM,".")-1 F II=1:1:NUMSP S FIELDNAM=$TR(FIELDNAM,".","_")
 S NUMSP=$L(FIELDNAM,"?")-1 F II=1:1:NUMSP S FIELDNAM=$TR(FIELDNAM,"?","_")
 S FILEORG=$P(Y,"^",4)
 S FLDTYPE=$P(Y,"^",2),NUMKEYS=$P(Y,"^",7),FLDPATH=$P(Y,"^",8)
 S TNAME=$P(Y,"^",9)
 S NUMSP=$L(TNAME," ")-1 F II=1:1:NUMSP S TNAME=$TR(TNAME," ","_")
 S NUMSP=$L(TNAME,"/")-1 F II=1:1:NUMSP S TNAME=$TR(TNAME,"/","_")
 S NUMSP=$L(TNAME,".")-1 F II=1:1:NUMSP S TNAME=$TR(TNAME,".","_")
 S NUMSP=$L(TNAME,"?")-1 F II=1:1:NUMSP S TNAME=$TR(TNAME,"?","_")
 ;I FLDTYPE["P" D  ;POINTER PROCESSING 
 ;.S PFILENUM=+$P(FLDTYPE,"P",2)
 ;.S PFN(PFILENUM)=FIELDNAM_"^"_NUMKEYS ;POINTERS
 I FLDTYPE="*Top Multiple*" D  Q  ;
 .S FILEXX=+$P(Y,"^",3),FIELDNUM=$P(Y,"^",4),FNUM=$P(Y,"^",5)
 .S MSG="|TABLEDEF|"_FILEXX_"|"_FIELDNUM_"[m]"_"|"_FIELDNAM_"|"_FNUM_"|" D WRMSG
 .S XPATH=$P(Y,"^",6),XTNAME=$P(Y,"^",7)
 .S NUMSP=$L(XTNAME," ")-1 F II=1:1:NUMSP S XTNAME=$TR(XTNAME," ","_")
 .S NUMSP=$L(NUMKEYS," ")-1 F II=1:1:NUMSP S NUMKEYS=$TR(NUMKEYS," ","_")
 .S MSG="|FIELDEF|"_FILEX_"|"_FLDX_"|"_FIELDNAM_"|"_FLDTYPE_"|"_FIELDLEN_"|"_NUMKEYS_"|"_FILEORG_"|"_XPATH_"|"_XTNAME_"|" D WRMSG
 S MSG="|FIELDEF|"_FILEX_"|"_FLDX_"|"_FIELDNAM_"|"_FLDTYPE_"|"_FIELDLEN
 S MSG=MSG_"|"_NUMKEYS_"|"_FILEORG_"|"_FLDPATH_"|"_TNAME_"|"
WRMSG ;WRITE MESSAGE
 U IO W MSG,!
 ;H 1
 Q
ENTRIES ;RETURN THE NUMBER OF ENTRIES IN A FILE
 ;
 I $D(ENTRIES)=0 S ENTRIES=0 
 W "|ENTRIES|"_ENTRIES_"|",!
 Q
SENDFILE          ;SEND ALL THE FILE MANAGER FILES
 ;|FILE|FILENUM|FILENAME|
 D FILES^ZDDUTIL S FILENUM="",CNTAUG=0
 F  S FILENUM=$O(^TMP($J,FILENUM)) Q:FILENUM=""  D FMSG
 U IO W "**ENDTX**",!
 Q
FMSG ;FILE MESSAGE
 S FILENAME=$G(^TMP($J,FILENUM))
 I CNTAUG>302 Q
 S CNTAUG=CNTAUG+1
 S MSG="|FILE|"_FILENUM_"|"_FILENAME_"|"
 U IO W MSG,!
 ;
 Q
CLEARCOM ;
 ;C IO O IO
 Q
