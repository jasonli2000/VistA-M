SDB1 ;GRR/ALB;29NOV84
 ;;Scheduling Version  ; 07/19/85
 ;DH=PATTERN  DO=EXPIRATION DATE  X=START DATE
B1 S DR=0,SB=STARTDAY-1/100,STR="{}&%?#@!$* XXWVUTSRQPONMLKJIHGFEDCBA0123456789jklmnopqrstuvwxyz",SDONE=1
X Q:X'<DO  I $D(^SC(DA,"ST",X,9)) S DR=X,SDSAV=0 G SM
 K ^SC(DA,"ST",X) I DR<0,$N(^(X))<0 Q
 G X2:X+1<DR
 S DR=$N(^SC(DA,"S",X)),SDSAV=0 G X2:DR\1-X
SM S SM=$P("SU^MO^TU^WE^TH^FR^SA",U,DOW+1)_" "_$E(X,6,7)_$J("",SI+SI-6)_DH_$J("",64-$L(DH)) S:'SDSAV SDSAV=1,SDPAT=SM
I S I=DR#1-SB*100,I=I#1*SI\.6+(I\1*SI)*2,S=$E(SM,I,999),SM=$E(SM,1,I-1)
 F Y=0:0 S Y=$N(^SC(DA,"S",DR,1,Y)) Q:Y<0  I $P(^(Y,0),"^",9)'["C" F I=1:1:$P(^(0),U,2)\(60\HSI) S ST=$E(S,I+I) S:ST="" ST=" " S S=$E(S,1,I+I-1)_$E(STR,$F(STR,ST)-2)_$E(S,I+I+1,999) D OB
 S SM=SM_S,DR=$N(^SC(DA,"S",DR)) I DR\1=X G I
 I $L(SM)>SM S ^SC(DA,"ST",X,0)=X,^(1)=SM I $D(^SC(DA,"ST",X,9)) S ^SC(DA,"OST",X,1)=SDPAT
X2 I X#100<22 S X=X+7
 E  S X1=X,X2=7 D C^%DTC
 G X
 ;
D W $P("SUN^MON^TUES^WEDNES^THURS^FRI^SATUR",U,DOW+1),"DAYS " S DH=X,OK=0,CTR=0
 F X=D0:0 S X=$N(^SC(DA,"T",X)) Q:X'>0  D DOW^SDM0 I Y=DOW S Y=X,DO=Y W "UNTIL " D DT^DIO2 G R
 I X'>0,$D(SDIN),SDIN>D0 S SDRE1=$S(SDRE=0:9999999,1:SDRE) S X=SDIN F I=0:1:6 D DOW^SDM0 S:Y=DOW OK=1 Q:OK  S X1=X,X2=1 D C^%DTC Q:X>SDRE1
 I OK S Y=X,DO=D0 W " UNTIL " D DT^DIO2 G R
 S DO=9999999 W "INDEFINITELY"
R K OK R "? ",Y,! S D=D0 G 1:Y?1"N".A
 S Y="" I '$D(^SC(DA,"T"_DOW,D0,1)) S Y=$N(^SC(DA,"T"_DOW,D0)) I Y>D0 S X=^(Y,1),POP=0 D CHK1 K:'POP ^SC(DA,"T"_DOW,Y) S ^SC(DA,"T"_DOW,D0,1)=X
 I Y<0,'$D(^(D0)) S ^(D0,1)=""
 S ^SC(DA,"T"_DOW,DO,1)=DH
 S X=D0 D B1 S MAX=30,SC=DA,STARTDATE=SD G:'CNT G1^SDB D WAIT^DICD,OVR^SDAUT1 W !,"PATTERN FILED!",! S SDREACT=1 G G1^SDB
 ;
1 I SDEL D APPCK I POP D DELERR G OVR
 G:$D(^HOLIDAY(D,0)) OVR S POP=0 D:$D(SDIN) CHK2 G:POP OVR W !,"...FOR " S Y=D D DT^DIO2 R "? NO// ",Y G G1^SDB:Y[U
 I Y'?1"Y".A G OVR
 S POP=0 D APPCK I POP D APPERR G:(%-1) OVR
 W " ...OK" S X=D,DO=X+1,^SC(DA,"ST",X,9)=DA,SDREACT=1 D B1
OVR I D#100<22 S D=D+7 S POP=0 D:$D(SDIN) CHK2 G G1^SDB:POP=1,1
 S X1=D,X2=7 D C^%DTC S D=X S POP=0 D:$D(SDIN) CHK2 G G1^SDB:POP=1,1
 ;
APPCK F A=D:0 S A=$N(^SC(DA,"S",A)) Q:A'>0!(A\1-D)  I $P(^SC(DA,"S",A,0),"^",9)'["C" S POP=1 Q
 Q
APPERR W *7,!,"THERE ARE ALREADY APPOINTMENTS PENDING ON THIS DATE",!,"ARE YOU SURE YOU WANT TO CHANGE THE EXISTING AVAILABILITY" S %=2 D YN^DICN
 I %Y?.E1"?" W !,"IF YOU SAY YES, THE EXISTING APPOINTMENTS MAY BECOME OVERBOOKS WHEN THE NEW AVAILABILITY IS APPLIED",!,"ANSWER YES OR NO" G APPERR
 Q
DELERR S Y=D W !,"... " D DT^DIQ W " HAS PENDING APPTS - DELETE AVAILABILITY NOT ALLOWED" Q
CHK1 Q:'$D(SDIN)
 I Y=SDIN S POP=1
 Q
 ;
CHK2 I SDIN<D,SDRE=0 S POP=1 Q
 I SDIN<D,SDRE>D S POP=2,D=SDRE,X=D F I=0:1:6 D DOW^SDM0 Q:Y=DOW  S X1=D,X2=1 D C^%DTC S D=X
 W:POP=2&('CTR) !!,"    Clinic is inactive from ",$E(SDIN,4,5),"/",$E(SDIN,6,7),"/",$E(SDIN,2,3)," to ",$E(SDRE1,4,5),"/",$E(SDRE1,6,7),"/",$E(SDRE1,2,3),! S:POP=2 CTR=1
 I SDRE'>D,SDRE'=0 K SDIN
 Q
OB S SDSLOT=$E(STR,$F(STR,ST)-2) I SDSLOT?1P,SDSLOT'?1" " S ^SC(DA,"S",DR,1,Y,"OB")="O" Q
 K ^SC(DA,"S",DR,1,Y,"OB") Q
