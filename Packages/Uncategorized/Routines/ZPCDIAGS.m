ZPCDIAG ; PROGRAM TO CONDUCT PC TO HOST DIALOG 0 ;8/7/96  09:16
 ;Program monitors client PC for messages and pulls M data.
 ;AMT COPYRIGHT 1994 ASPIRE TECHNOLOGY
 ;S $ZT="^%ET" ;SET THE ERROR TRAP
SET S IO=$I,CNT=0,BAD=0,XCNT=0 ;****IO=84 ON LBA
 C IO O IO ;:(0:255::255:1) ;RIGHT MARGIN:OUTPUT RING BUFFER::INPUT RING BUFFER:SET BITS IN STATUS WORD
 ;
READ ;MAY WANT TO TURN ECHO OFF!!!
 ;PASS = PASSWORD
 ;U IO:WIDTH=255 R " PASSWORD :",PASS:40 I '$T G HALT
 ;MAIN LOOP FOR INPUT
 S C=0
LP U IO X ^%ZOSF("EOFF") S X=255 X ^%ZOSF("RM")
 R X:335
ENLP S:$D(C)=0 C=1 S C=C+1 S ^ZSQLINT($J,"CMDLOG",C)=X_"TIME:"_$H
 ;X ^%ZOSF("EON")
 I '$T W "***M TIME OUT***",! G HALT ;GET OUT IF TIME OUT
 ;I X["NO CONNECTION" G HALT
 ;I X'["~~" U IO W "***NAK",! G LP ;NO CHKSUM
 ;X IS THE INCOMING DATA
 ;XCNT COUNTS ALL RECORDS RECEIVED
 ;RCHK IS THE RECEIVED CHECK SUM
 ;CHKSUM IS THE CALCULATED (HOST) CHECK SUM
 ;BAD IS THE COUNTER FOR FAILED TRANSMISSIONS
 I X["$$END" G DONE ;ALL DONE NO CRC SEND ON THIS LINE
 I X="" G LP
 S INSTR=$P(X,"|",2)
 I INSTR="SENDD" D SENDD^ZDDUTIL1 G LEAP ;SEND DATA DICTIONARY
 I INSTR="SENDFILES" D SENDFILE^ZZDDUTIL1 G LEAP ;SEND FILES
 I INSTR="ACKNOW" D ACKNOW G LEAP ;SEND PC AN ACK
 ;I INSTR="GET" D GETDATA D SEND G LEAP ;GET A FIELD VALUE
 I INSTR="TEMPLATE" S NOTEMP=0 D ^ZPCDI G:NOTEMP=0 LP G:NOTEMP=1 ENLP ;DO TEMPLATE THINGS
 I INSTR="FUNCTION" D START^ZPCMFUNC G LP ;DO M FUNCTION
 I INSTR="CALC" D CALC D SEND G LEAP ;CONPUTE SOMETHING
 I INSTR="LISTIN" D LISTIN G LP ;'GET A LIST FROM CLIENT
 I INSTR="DO" D DOPROG W "**ENDTX**",! G LP ;EXECUTE A PROGRAM
CLIN I INSTR="LABRESULT" D LABRES^ZPCUTL1 W "**ENDTX**",! G LP
 I INSTR="WARDS" D WARDS^ZPCUTL3 G LP
 I INSTR="DOC" D DOC^ZPCUTL3 G LP
 I INSTR="DOCS" D DOCS^ZPCUTL3 G LP
 I INSTR="CLINIC" D CLINIC^ZPCUTL3 G LP
 I INSTR="MEDS" S DFN=$P(X,"|",3) D MED^ZPCMBCP1 W "**ENDTX**",! G LP
 ;I INSTR="TEST" D ^AUGTEST G LEAP
 I INSTR="LOGOFF"!(INSTR="QUIT")!(INSTR="EXIT") G DONE
 I INSTR="LINETEST" D  W "**ENDTX**" G LP
 .F JJ=1:1:300 W JJ,"  This is a test of the transmission line.",!
 I INSTR="PTLOOKUP" D DPT^ZPCUTL1 W "**ENDTX**",! G LP
LEAP ;JUMP OVER POINT
 G LP ;LOOP BACK
 S RCHK=$P(X,"~~",2),X=$P(X,"~~",1) D CHKSUM
 Q
STRIP ;STRIP ANY LEADING SPACES (UP TO 20)
 F I=1:1:20 S EXPOS=I-1 S:I=1 EXPOS=1 S:$E(RCHK,I)=" " RCHK=+$E(RCHK,I+1,254) Q:$E(RCHK,EXPOS)'=" "
 Q
 I CHKSUM'=RCHK U IO W "***NAK",! H 1 S BAD=BAD+1 G:BAD>20 HALT G LP
 U IO W "***ACK",!
 S CNT=CNT+1 ;L,^ZZVALAB("X",CNT)=X
 G LP
ACKNOW ;ACKNOWLEDGE M --> PC
 D CLEARCOM
 U IO W "**PRESENT**",!
 Q
CLEARCOM ;
 ;C IO O IO
 Q
SENDFILE          ;SEND ALL THE FILE MANAGER FILES
 ;|FILE|FILENUM|FILENAME|
 D FILES^ZDDUTIL S FILENUM="",CNTAUG=0
 F  S FILENUM=$O(^TMP($J,FILENUM)) Q:FILENUM=""  D FMSG
 U IO W "**ENDTX**",!
 Q
FMSG ;FILE MESSAGE
 S FILENAME=$G(^TMP($J,FILENUM))
 I CNTAUG>302 Q
 S CNTAUG=CNTAUG+1
 S MSG="|FILE|"_FILENUM_"|"_FILENAME_"|"
 U IO W MSG,!
 ;
 Q
GET ;GET DATA WITH CALLS TO DIQ1
 ;NEED ARGS
 ;|DATAGET|FILE#|FIELD#|SUBFILE#|SUBFIELD#|RECNUM|SUBREC#|
 I $D(DUZ)=0 S DUZ=1,U="^"
 S X="|DATAGET|100|.01|||1||"
 K DR,FILENUM,FIELDNUM,SUBFILE,DA,SUBDA
 S FILENUM=$P(X,"|",3),FIELDNUM=$P(X,"|",4),SUBFILE=$P(X,"|",5)
 S SUBFIELD=$P(X,"|",6),DA=$P(X,"|",7),SUBDA=$P(X,"|",8)
 I SUBFILE]"",SUBFIELD]"",SUBDA]"" D  ;
 .S DR(SUBFILE)=SUBFIELD,DA(SUBFILE)=SUBREC
 S DIC=FILENUM,DR=FIELDNUM
 S DIQ(0)="E" ;EXTERNAL VALUES
 S DIQ="ANS" ;PUT ANSWER HERE
 D EN^DIQ1
 S ANSREF=$Q(ANS),ANS=@ANSREF
 Q
CALC ;CALCULATE SOMETHING
 ;
 Q
DOPROG ;DO AN M PROGRAM
 K ARG1,ARG2,ARG3
 S PRG=$P(X,"|",3) I PRG="" Q
 S ARG1=$P(X,"|",4),ARG2=$P(X,"|",5),ARG3=$P(X,"|",6)
 D @PRG
 ;
 Q
SEND ;SEND THE RESULT BACK TO THE PC
 I $D(ANS)=0 S ANS="*NO DATA*"
 U IO W "|MRESULT|"_ANS
 Q
LISTIN ;GET A LIST FROM CLIENT
 K ^XTEMP($J)
GETMOR R XX:30 I '$T Q
 I XX["**ENDTX**" Q
 I XX'="" S ^XTEMP($J,XX)=""
 G GETMOR
CHKSUM ;CALC CHECK SUM POSITIONALLY DEPENDENT
 S NUMCHAR=$L(X),CHKSUM=0 F POS=1:1:NUMCHAR S CHKSUM=CHKSUM+(POS*$A($E(X,POS)))
 ;S ^AUGIE(C,"CHKSUM")=CHKSUM_"~~"_X_"~~"_RCHK
 Q
HALT ;GET OUT
 U IO W "***ERROR",! D DONE
 ;PROCESS DATA EVEN IF THERE WAS ERROR (MOVE IT TO DATA BASE.)
 Q
DONE ;
 X ^%ZOSF("EON")
 Q
