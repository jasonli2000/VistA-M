ZPCMBCP ;BCP PULL FUNCTIONS FOR SQL 11:49
 ;AMT/Birmingham Field Office
 ;
 I $D(U)=0 S U="^"
 I $D(DUZ)=0 S DUZ=1
 ;
START ;|FUNCTION|Func name|test name|all/list|table|
 S XIN=X
 I $D(DT)=0 S %DT="P",X="NOW" D ^%DT S DT=+Y
 S FUNC=$P(XIN,"|",3)  ;FUNCTION NAME
 S TABLE=$P(XIN,"|",6) ;Table name
 S RANGE=$P(XIN,"|",5) ;GET ALL OR LIST
 S TEST=$P(XIN,"|",4) ;TEST NAME
 S PCNT=0
 I RANGE="All" D  ;ALL DFNS
 .S DFN=0 F  S DFN=$O(^DPT(DFN)) Q:+DFN=0!(PCNT>1000000)  D  ;PCNT=PATIENT CNT
 ..S SSN=$P($G(^DPT(DFN,0)),"^",9)
 ..S NAME=$P($G(^DPT(DFN,0)),"^",1)
 ..I SSN'="" D @FUNC
 I RANGE="List" D  ;
 .S SSN="" F  S SSN=$O(^XTEMP($J,SSN)) Q:SSN=""  D  ;
 ..S DFN=$O(^DPT("SSN",SSN,""))
 ..I DFN="" Q
 ..S NAME=$P($G(^DPT(DFN,0)),"^",1)
 ..D @FUNC
 W "**ENDTX**",!
 Q
ENDEM R:20 XXX ;Start to traverse patient file
ENDEM2 ;ENTRY POINT FROM M ACQUIRE BCP
 S X=254 X ^%ZOSF("RM") ;SET RIGHT MARGIN
 S DFN=0,RECTX=0
 I $D(^ZSQLINT("DEMOG","DFN"))=1 S DFN=$P(^ZSQLINT("DEMOG","DFN"),"^",1),RECTX=$P(^ZSQLINT("DEMOG","DFN"),"^",2)
 S EXIT=0 ;NO EXIT
 F  S OLDDFN=DFN S DFN=$O(^DPT(DFN)) Q:+DFN=0!(EXIT=1)  D  ;
 .S X=$G(^DPT(DFN,0)),NAME=$P(X,"^",1),SSN=$P(X,"^",9)
 .D DEMOG S ^ZSQLINT("DEMOG","DFN")=DFN
 K ^ZSQLINT("DEMOG")
 S ^ZSQLINT("DEMOG","FINISHED")=$H
 Q
ENADM ;ADMISSION ENTRY
 R XX:20
ENADM2 S X=254 X ^%ZOSF("RM") ;SET RIGHT MARGIN
 S DFN=0,RECTX=0,PCNT=0
 I $D(^ZSQLINT("ADM","DFN"))=1 S DFN=$P(^ZSQLINT("ADM","DFN"),"^",1),RECTX=$P(^ZSQLINT("ADM","DFN"),"^",2)
 S EXIT=0 ;NO EXIT
 F  S OLDDFN=DFN S DFN=$O(^DPT(DFN)) Q:+DFN=0!(EXIT=1)  D  ;
 .S X=$G(^DPT(DFN,0)),NAME=$P(X,"^",1),SSN=$P(X,"^",9)
 .D ADM S ^ZSQLINT("ADM","DFN")=DFN
 K ^ZSQLINT("ADM")
 S ^ZSQLINT("ADM","FINISHED")=$H
 Q
 ;
CHECK ;
 R XIN:3600 I '$T W "Timeout" S EXIT=1
 ;I XIN["*OK" S ^ZSQLINT1("DFN")=DFN_"^"_RECTX Q
 S EXIT=1 S ^ZSQLINT("DFN")=OLDDFN_"^"_"ERROR:"_$H Q  ;NO GOOD
 Q
 G EXIT
DEMOG I $D(^DPT(DFN,0))=0 Q
 ;
 K ANS,FLD S REC="" ;CLEAR THE DATA ARRAY
 S FLD(1)=NAME,FLD(2)=SSN
 I X="" Q  ;GET RID OF INCOMPLETE RECORDS-GARBAGE DATA
 ;W "**BEG TX:PATIENT_UD",!
MOREDATA ;
 ;S DFN=307
 S DIC=2,DR=.06,DA=DFN,FILENUM=DIC D GETFM ;RACE
 I ANS="" S ANS="UNKNOWN"
 S FLD(3)=ANS ;RACE
 S DR=.02 D GETFM ;SEX
 S FLD(4)=ANS
 S DR=.03 D GETFMI ;DOB
 ;I $L(ANS,",")=1 S ANS="JAN 1, "_ANS
 S X=ANS D DTC S ANS=DTXX
 I $L(ANS)>14 S ANS=""
 S FLD(5)=ANS
 S DR=.351 D GETFMI ;EXPIRATION
 I ANS["@" S ANS=$P(ANS,"@",1)
 ;I ANS'="" I $L(ANS,",")=0 S ANS="JAN 1,"_ANS
 I ANS'="" S X=ANS D DTC S ANS=DTXX ;CONVERT DATE FROM JAN 1, 1997 TO 1/1/1997
 S FLD(6)=ANS ;I $L(ANS))>8
MARITAL S DR=.05 D GETFM ;MARITAL STATUS
 S FLD(7)=""
 I ANS]"" S FLD(7)=ANS
 S DR=537025 D GETFM ;NETWORK IDENTIFIER
 S FLD(8)=ANS
 S DR=.131 D GETFM ;TELEPHONE
 S FLD(9)=ANS
 S DR=.1112 D GETFM
 S FLD(10)=ANS ;ZIP
 S DR=.323 D GETFM ;PERIOD OF SERVICE
 S FLD(11)=ANS
 S DR=.301 D GETFM ;SERVICE CONNECTED
 S FLD(12)=ANS
 S DR=.07 D GETFM
 S FLD(13)=ANS ;OCCUPATION
 S DR=.32102 D GETFM
 S FLD(14)=ANS ;AGENT ORANGE
 S DR=.32201 D GETFM
 S FLD(15)=ANS ; PERSIAN GUULF
 S DR=404.01 D GETFM
 S FLD(16)=ANS
 S DRDA=$P($G(^DPT(DFN,"PC")),"^",1)
 S DRNUM="" I DRDA'="" S DRNUM=$P($G(^VA(200,DRDA,"PS")),"^",3)
 S FLD(17)=DRNUM
 F I=1:1:17 S REC=REC_FLD(I)_"^"
 S REC=$E(REC,1,$L(REC)-1)
 I $L(REC)>254 S ^ZSQLINT("ERRLEN",SSN)=REC
 E  W REC,!
 Q
TODO ;FIND ITEMS TO DO
 D ADM
 D LAB
 D MED
 I $D(^ZSQLINT("STOP"))=1 S EXIT=1 Q  ;WANT A GRACEFUL STOP AFTER RECORD DONE
 Q
ADM ;ADMISSION TABLE
 I $D(^DGPM("APTT1",DFN))=0 Q  ;W !,"NO ADMISSIONS" Q
 S PCNT=PCNT+1
 S ADMDT=0
 F  S ADMDT=$O(^DGPM("APTT1",DFN,ADMDT)) Q:ADMDT=""  D ADMX ;
 Q
ADMX ;
 ;W !,"** ADMDT=",ADMDT
 S DAPM=0
 F  S DAPM=$O(^DGPM("APTT1",DFN,ADMDT,DAPM)) Q:DAPM'>0  D ADMXX ;DAPM INT PATIENT MOVMT NUMBER
 Q
ADMXX ;CONTINUE LOOP
 ;W !,"ADMDR=",ADMDT," ","DAPM=",DAPM
 S MOVDATA=$G(^DGPM(DAPM,0))
 ;W !!,$P(MOVDATA,"^",19) ;ATTENDING PHYSICIAN
 S TXACT=$P(MOVDATA,"^",2)
 I TXACT=1 S TXACTN="ADMISSION"
 I TXACT=3 S TXACTN="DISCHARGE"
 ;W !,"MOVDATA=",$P(MOVDATA,"^",1)
 S DISDA=$P(MOVDATA,"^",17)
 D ICD
 S DISDT="" I DISDA]"" S DISDT=$P($G(^DGPM(DISDA,0)),"^",1)
 ;W !,"DISDT=",DISDT
 S DIAGSHORT=$P($G(^DGPM(DAPM,0)),"^",10)
ADMYY S X=ADMDT D DTC S ADMDTX=DTXX
 ;W "**BEG TX:ADMISSION_UD",!
 S REC=""
 S FLD(1)=NAME
 S FLD(2)=SSN
 S FLD(3)=ADMDTX
 S X=DISDT D DTC S DISCHDT=DTXX
 S FLD(4)=DISCHDT
 S FLD(5)=DIAGSHORT
 S FLD(6)=ICD1DES ;ICD9 NAME 1
 S FLD(7)=ICD1N ;ICD9 NUM1
 S FLD(8)=ICD1DRG ;ICD9 DRG1
 S FLD(9)=ICD2DES ;ICD9 NAME2
 S FLD(10)=ICD2N ;ICD9 NUM2
 S FLD(11)=ICD2DRG ;ICD9 DRG2
 S FLD(12)=ICD3DES ;ICD9 NAME3
 S FLD(13)=ICD3N ;ICD9 NUM3
 S FLD(14)=ICD3DRG ;ICD9 DRG3
 F X=1:1:14 S REC=REC_FLD(X)_"^"
 S REC=$E(REC,1,$L(REC)-1)
 I $L(REC)>254 S ^ZSQLINT("ADM","ERRLEN",DFN)=$E(REC,1,254)
 E  W REC,!
 Q
GETFM ;GET FILEMAN DATA
 ;NEED DIQ,DA,DR FOR SUBFILE Need DR(SUbfile), DA(subfile)
 ;S FILENUM=DIC
 S DIQ="ANS",DIQ(0)="E" ;EXTERNAL VALUES
 D EN^DIQ1 S ANS=ANS(FILENUM,DA,DR,"E")
 Q
GETFMI ;GETFM INTERNAL VALUES
 S DIQ="ANS",DIQ(0)="I" D EN^DIQ1 S ANS=ANS(FILENUM,DA,DR,"I")
 Q
DTC ;DATE CONV Y2K COMPLIANT
 S YR=$E(X,2,3),MO=$E(X,4,5),DAY=$E(X,6,7),CENT=$E(X,1,1)
 I MO="00" S MO="01"
 I DAY="00" S DAY="01"
 S CEN="19" I CENT="3" S CEN="20"
 I CENT="1" S CEN="18"
 S YR=CEN_YR
 S DTXX=MO_"/"_DAY_"/"_YR I DTXX["//" S DTXX=""
 ;W "DTXX=",DTXX
 Q
ICD ;pulls ICD code info
 S ICD1DES="",ICD1N="",ICD1DRG="",ICD2DES=""
 S ICD2N="",ICD2DRG="",ICD3N="",ICD3DES="",ICD3DRG=""
 S PTF=$P($G(^DGPM(DAPM,0)),U,16)
 Q:PTF=""  ;PTF INTERNAL NUMBER
 S INC=0
 F  S INC=$O(^DGPT(PTF,"M",INC)) Q:+INC=0  D PTFX ;
 Q
PTFX ;
 S ICD1=$P($G(^DGPT(PTF,"M",INC,0)),"^",5)
 S ICD2=$P($G(^DGPT(PTF,"M",INC,0)),"^",6)
 S ICD3=$P($G(^DGPT(PTF,"M",INC,0)),"^",7)
 I ICD1]"" S ICD1N=$P($G(^ICD9(ICD1,0)),"^",1),ICD1DES=$P($G(^ICD9(ICD1,0)),"^",3)
 I ICD1]"" S ICD1DRG=$G(^ICD9(ICD1,"DRG"))
 I ICD2]"" S ICD2N=$P($G(^ICD9(ICD2,0)),"^",1),ICD2DES=$P($G(^ICD9(ICD2,0)),"^",3)
 I ICD2]"" S ICD2DRG=$G(^ICD9(ICD2,"DRG"))
 I ICD3]"" S ICD3N=$P($G(^ICD9(ICD3,0)),"^",1),ICD3DES=$P($G(^ICD9(ICD3,0)),"^",3)
 I ICD3]"" S ICD3DRG=$G(ICD9(ICD3,"DRG"))
 Q
